---
title: "Upper Oconee AR maps and analysis"
author: "Quentin D. Read"
date: "`r Sys.Date()`"
output: 
  html_document:
      css: "gtstyle.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Summary

In this document, I put together the Upper Oconee data and got some external data to make maps. I also made some exploratory data analysis plots and then fit a formal statistical model. All of this focuses on Question 1 from your original list of research questions: do environmental factors influence the presence and absence of antibiotic resistant taxa? Basically, the answers are not that different from the analysis that the UGA statistician did, which is a great thing (it means the results are robust and patterns tend to come through regardless of what analysis is used) but on the other hand I also think there is now much more nuance.

I suppressed the display of some of the code but I kept some of the more important code displayed in here so that you can see what I did.

Note: I now use a model that accounts for the non-independence of observations from the same site and from the same time. However I did not actually incorporate the spatial locations of the sites into the model explicitly. I don't think that is worth the additional effort it would take, and is unlikely to show anything new. So the question moving forward is what to do next. I should hopefully ultimately have time to put this same approach toward the other parts of your research questions beyond Question 1, but I wanted to share this with you all first to get your opinion.

OK, let's get to it.

## Processing the spatial data

The spatial data needed are:

- boundaries of the Upper Oconee watershed
- [National Land Cover Database (NLCD)](https://mrlc.gov/data) land cover type and impervious surface percentage raster data
- [National Hydrography Database (NHD)](https://www.usgs.gov/national-hydrography/access-national-hydrography-products) paths of streams and rivers in the watershed

[Main page for USGS hydrography data](https://www.usgs.gov/national-hydrography/access-national-hydrography-products)

To get the boundaries of the Upper Oconee, I looked up its [HUC8 watershed code](https://water.usgs.gov/lookup/getwatershed?03070101) which is `03070101`. I went to [this download page](https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Hydrography/WBD/HU2/GPKG/) and downloaded [this file of the HUC2 watershed boundaries for the Southeastern USA](https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/WBD/HU2/GPKG/WBD_03_HU2_GPKG.zip) and pulled out the polygon for the Upper Oconee (see below).

To get the NLCD land cover type and impervious surface rasters, I downloaded the data for the entire USA (large files) from [this MRLC download page](https://www.mrlc.gov/data?f%5B0%5D=year%3A2019). The specific files I downloaded were [this one for 2019 land cover](https://s3-us-west-2.amazonaws.com/mrlc/nlcd_2019_land_cover_l48_20210604.zip) and [this one for 2019 impervious surface](https://s3-us-west-2.amazonaws.com/mrlc/nlcd_2019_impervious_l48_20210604.zip).

To get the NHD stream and river paths, I went to [this download page](https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Hydrography/NHD/HU8/GPKG/) and downloaded [this file for the Upper Oconee HUC8 watershed](https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/NHD/HU8/GPKG/NHD_H_03070101_HU8_GPKG.zip).

Load the R packages.

```{r}
library(sf)
library(readxl)
library(dplyr)
library(tidyr)
library(data.table)
library(stringr)
library(zoo)
library(ggplot2)
library(lme4)
library(emmeans)
library(brms)
library(tidybayes)
library(brmsmargins)
library(gt)
library(glue)

theme_set(
  theme_bw() +
    theme(strip.background = element_blank(),
          panel.grid = element_blank())
)

options(mc.cores = 4, brms.backend = 'cmdstanr', brms.file_refit = 'on_change')
```

First load the coordinates and convert to a shapefile. Save as a GeoPackage shapefile for future use. Do the same for the boundary of the Upper Oconee watershed. Also get the smaller HUC12 watershed boundaries that are contained within the single boundary of the Upper Oconee. (Note: this portion of the code is not run when the notebook is created.)

```{r, eval = FALSE}
site_locs <- read_xlsx('project/AR paper_sampling sites_location.xlsx')
names(site_locs) <- c('site', 'lat', 'lon')

site_sp <- st_as_sf(site_locs, coords = c('lon', 'lat'), crs = st_crs('+proj=longlat')) %>%
  mutate(area = substr(site, 1, 4))

st_write(site_sp, 'project/sites.gpkg', driver = 'GPKG')

st_layers('~/spatial_data/WBD_03_HU2_GPKG.gpkg')
huc8s <- st_read(dsn = '~/spatial_data/WBD_03_HU2_GPKG.gpkg', layer = 'WBDHU8')
upper_oconee <- huc8s %>% filter(huc8 == '03070101')

st_write(upper_oconee, 'project/upper_oconee.gpkg', driver = 'GPKG')

huc12s <- st_read(dsn = '~/spatial_data/WBD_03_HU2_GPKG.gpkg', layer = 'WBDHU12')
upper_oconee_huc12s <- huc12s %>% filter(substr(huc12, 1, 8) == '03070101') %>%
  st_transform(crs = st_crs(site_sp))

# Get only the huc12s intersecting with the sites.
huc12s_use <- apply(st_intersects(upper_oconee_huc12s, site_sp, sparse = FALSE), 1, any)
st_write(upper_oconee_huc12s[huc12s_use,], 'project/study_region_huc12s.gpkg', driver = 'GPKG')
```

Transform watershed boundary shapefile to the same projection as the NLCD rasters so it can be used to crop them.

```{r, eval = FALSE}
library(stars)
nlcd <- read_stars('~/spatial_data/nlcd_2019_land_cover_l48_20210604.img')
upper_oconee <- st_read('project/upper_oconee.gpkg')
upper_oconee_AEA <- st_transform(upper_oconee, crs = st_crs(nlcd))
st_write(upper_oconee_AEA, 'project/upper_oconee_AEA.gpkg', driver = 'GPKG')
```

Finally, crop the NLCD raster to those boundaries. This is done with a shell script on SciNet because I do not have my local computer configured to use GDAL in this way.

```{bash, eval = FALSE}
module load gdal
cd /project/qdr/spatial

gdalwarp -crop_to_cutline -cutline upper_oconee_AEA.gpkg -of GTiff nlcd_2019_land_cover_l48_20210604.img nlcd_land_cover_upper_oconee.tif
gdalwarp -crop_to_cutline -cutline upper_oconee_AEA.gpkg -of GTiff nlcd_2019_impervious_l48_20210604.img nlcd_impervious_upper_oconee.tif
```

## Read and process raw data

Next, read the raw data in and convert it to a form usable for analysis and mapping. We will need to:

- Fill in environmental data covariates in cases where a sample has multiple isolates.
- Distinguish rows where species is `-` from rows where there is no data.
- Create separate datasets for environmental covariates, lactamase presence-absence, antibiotic concentrations, and ARG absolute and relative copy numbers that can be joined together later.

Some code here was copied from the UGA statistician's code. While looking at the UGA statistician's code I noticed that they removed any isolate beyond the first from the dataset from each sample. So that is probably not good. I have corrected this. (Code not shown here as it is very long.)

```{r, eval = FALSE, echo = FALSE}
water_sample_rawdata <- read_xlsx('project/AR paper_stat analysis_tables.xlsx', sheet = 'water samples', skip = 7) |> setDT()
wastewater_sample_rawdata <- read_xlsx('project/AR paper_stat analysis_tables.xlsx', sheet = 'wastewater samples', skip = 6) |> setDT()

# Column names created by UGA statistician
correct_names_watersample = c("sample_no", 'season', 'site', 
                              'temperature','pH','conductivity','turbidity','Ecoli_counts',
                              'Bl_species',
                              'Bl_Amp','Bl_Faz','Bl_Fep','Bl_Fot','Bl_Fox','Bl_Pod','Bl_Taz','Bl_Axo','Bl_Cep','Bl_Cip','Bl_Gen','Bl_Imi','Bl_P_T4','Bl_Mer',
                              'Bl_blaCTX_M','Bl_blaTEM','Bl_blaCMY_2','Bl_blaSHV','Bl_blaOXA','Bl_blaIMI_NmcA','Bl_blaKPC',
                              'ESBL','CRE',
                              'AR_Ecoli_presence',
                              'AR_Ecoli_Amo_Cla','AR_Ecoli_Amp','AR_Ecoli_Azi','AR_Ecoli_Chl','AR_Ecoli_Fox','AR_Ecoli_Tio','AR_Ecoli_Axo','AR_Ecoli_Cip','AR_Ecoli_Gen','AR_Ecoli_Nal','AR_Ecoli_Str','AR_Ecoli_Sul','AR_Ecoli_Tet','AR_Ecoli_Tri_Smx',
                              'Salmonella_presence',
                              'Salmonella_Amo_Cla','Salmonella_Amp','Salmonella_Fox','Salmonella_Tio','Salmonella_Axo','Salmonella_Chl','Salmonella_Gen','Salmonella_Str','Salmonella_Sul','Salmonella_Tet',
                              'Enterococcus_presence',
                              'Enterococcus_Cip','Enterococcus_Dap','Enterococcus_Ery','Enterococcus_Lin','Enterococcus_Nit','Enterococcus_Pen','Enterococcus_Str','Enterococcus_Syn','Enterococcus_Tet','Enterococcus_Tyl',
                              'Amo','Amp','Azi','Axo','Taz','Tio','Cip','Dap','Ery','Gen','Kan','Lin','Lnz','Mer','Met','Nal',
                              'Oxa','Pen','Smx','Sul','Str','Tig','Tri','Tet','Tyl','Van','total',
                              'abs_ermB','abs_tetB','abs_blaKPC','abs_blaSHV','abs_qnrS','abs_blaCTX-M','abs_total',
                              'rlt_ermB','rlt_tetB','rlt_blaKPC','rlt_blaSHV','rlt_qnrS','rlt_blaCTX-M','rlt_total'
)

setnames(water_sample_rawdata, correct_names_watersample)
water_sample_rawdata[, area := substr(site, 1, 4)]
water_sample_rawdata[, season := tolower(season)]

# Create environmental dataframe with no duplicated rows
id_cols <- c(correct_names_watersample[1:3], 'area')
env_cols <- c(id_cols, correct_names_watersample[4:8])

water_sample_environmental <- water_sample_rawdata[, ..env_cols]
water_sample_environmental <- water_sample_environmental[!is.na(sample_no) & !duplicated(sample_no)]

# Separate the column with AR salmonella presence and number of isolates combined into one column into two separate columns
water_sample_rawdata[, Salmonella_n_isolates := as.numeric(str_extract(Salmonella_presence, '[0-9]'))]
water_sample_rawdata[, Salmonella_presence := substr(Salmonella_presence, 1, 1)]

# Separate antibiotic concentrations into a separate dataframe
antibiotic_conc_idx <- which(names(water_sample_rawdata) == 'Amo'):which(names(water_sample_rawdata) == 'total')
antibiotic_conc_cols <- c(id_cols, names(water_sample_rawdata)[antibiotic_conc_idx])

# Here also get rid of the duplicated rows
water_sample_antibiotic_conc <- water_sample_rawdata[, ..antibiotic_conc_cols]
water_sample_antibiotic_conc <- water_sample_antibiotic_conc[!is.na(sample_no) & !duplicated(sample_no)]

# Separate ARG copy numbers into a separate dataframe
arg_copy_cols <- c(id_cols, grep('(^abs)|(^rlt)', names(water_sample_rawdata), value = TRUE))

# Again, get rid of the duplicated rows
water_sample_arg_copynum <- water_sample_rawdata[, ..arg_copy_cols]
water_sample_arg_copynum <- water_sample_arg_copynum[!is.na(sample_no) & !duplicated(sample_no)]

# Separate beta-lactamase into a separate dataframe
bl_cols <- c(id_cols, grep('^Bl_', names(water_sample_rawdata), value = TRUE))
water_sample_bl <- water_sample_rawdata[, ..bl_cols]

# Here, we may have multiple rows per sample so fill in the id columns down for those samples, then convert - and + to 0 and 1.
water_sample_bl[, (id_cols) := lapply(.SD, na.locf), .SDcols = id_cols]
pres_abs_cols <- bl_cols[!bl_cols %in% c(id_cols, 'Bl_species')]
water_sample_bl[, (pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = pres_abs_cols]

# Separate AR bacteria (E.coli, Salmonella, and MDR Enterococcus) into a separate dataframe
ar_pres_abs_cols <- c(grep('^AR_Ecoli', names(water_sample_rawdata), value = TRUE), grep('^Salmonella', names(water_sample_rawdata), value = TRUE), grep('^Enterococcus', names(water_sample_rawdata), value = TRUE), 'ESBL', 'CRE')
ar_cols <- c(id_cols, ar_pres_abs_cols)
water_sample_ar <- water_sample_rawdata[, ..ar_cols]

# Again, fill in the ID columns down for any samples with multiple rows, then convert - and + to 0 and 1.
water_sample_ar[, (id_cols) := lapply(.SD, na.locf), .SDcols = id_cols]
water_sample_ar[, (ar_pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = ar_pres_abs_cols]
```

```{r, eval = FALSE, echo = FALSE}
correct_names_wastewater = c("sample_no", 'season', 'site', 'Ecoli_counts',
                             'Bl_species',
                             'Bl_Amp','Bl_Faz','Bl_Fep','Bl_Fot','Bl_Fox','Bl_Pod','Bl_Taz','Bl_Axo','Bl_Cep','Bl_Cip','Bl_Gen','Bl_Imi','Bl_P_T4','Bl_Mer',
                             'Bl_blaCTX_M','Bl_blaTEM','Bl_blaCMY_2','Bl_blaSHV','Bl_blaOXA','Bl_blaIMI_NmcA','Bl_blaKPC',
                             'ESBL','CRE',
                             'AR_Ecoli_presence',
                             'AR_Ecoli_Amo_Cla','AR_Ecoli_Amp','AR_Ecoli_Azi','AR_Ecoli_Fox','AR_Ecoli_Tio','AR_Ecoli_Axo','AR_Ecoli_Cip','AR_Ecoli_Gen','AR_Ecoli_Nal','AR_Ecoli_Str','AR_Ecoli_Sul','AR_Ecoli_Tet','AR_Ecoli_Tri_Smx',
                             'Salmonella_presence',
                             'Salmonella_Str','Salmonella_Tet',
                             'Enterococcus_presence',
                             'Enterococcus_Cip','Enterococcus_Dap','Enterococcus_Ery','Enterococcus_Lin','Enterococcus_Nit','Enterococcus_Pen','Enterococcus_Str','Enterococcus_Syn','Enterococcus_Tet','Enterococcus_Tyl',
                             'Amo','Amp','Azi','Axo','Taz','Tio','Cip','Dap','Ery','Gen','Kan','Lin','Lnz','Mer','Met','Nal',
                             'Oxa','Pen','Smx','Sul','Str','Tig','Tri','Tet','Tyl','Van','total',
                             'abs_ermB','abs_tetB','abs_blaKPC','abs_blaSHV','abs_qnrS','abs_blaCTX-M','abs_total',
                             'rlt_ermB','rlt_tetB','rlt_blaKPC','rlt_blaSHV','rlt_qnrS','rlt_blaCTX-M','rlt_total'
)

# Correct names and create indicator column for influent versus effluent
setnames(wastewater_sample_rawdata, correct_names_wastewater)
wastewater_sample_rawdata <- separate(wastewater_sample_rawdata, site, into = c('site', 'type'), sep = ' ')
wastewater_sample_rawdata[, season := tolower(season)]

ww_id_cols <- c('sample_no', 'season', 'site', 'type')

# Create data frame with just ecoli counts that can be used as a key to join all the other ones together
ecoli_cols <- c(ww_id_cols, 'Ecoli_counts')
wastewater_sample_ecolicounts <- wastewater_sample_rawdata[, ..ecoli_cols]
wastewater_sample_ecolicounts <- wastewater_sample_ecolicounts[!is.na(sample_no) & !duplicated(sample_no)]

# Separate the column with AR salmonella presence and number of isolates combined into one column into two separate columns
wastewater_sample_rawdata[, Salmonella_n_isolates := as.numeric(str_extract(Salmonella_presence, '[0-9]'))]
wastewater_sample_rawdata[, Salmonella_presence := substr(Salmonella_presence, 1, 1)]

# Separate antibiotic concentrations into a separate dataframe
antibiotic_conc_idx <- which(names(wastewater_sample_rawdata) == 'Amo'):which(names(wastewater_sample_rawdata) == 'total')
antibiotic_conc_cols <- c(ww_id_cols, names(wastewater_sample_rawdata)[antibiotic_conc_idx])

# Here also get rid of the duplicated rows
wastewater_sample_antibiotic_conc <- wastewater_sample_rawdata[, ..antibiotic_conc_cols]
wastewater_sample_antibiotic_conc <- wastewater_sample_antibiotic_conc[!is.na(sample_no) & !duplicated(sample_no)]

# Separate ARG copy numbers into a separate dataframe
arg_copy_cols <- c(ww_id_cols, grep('(^abs)|(^rlt)', names(wastewater_sample_rawdata), value = TRUE))

# Again, get rid of the duplicated rows
wastewater_sample_arg_copynum <- wastewater_sample_rawdata[, ..arg_copy_cols]
wastewater_sample_arg_copynum <- wastewater_sample_arg_copynum[!is.na(sample_no) & !duplicated(sample_no)]

# Separate beta-lactamase into a separate dataframe
bl_cols <- c(ww_id_cols, grep('^Bl_', names(water_sample_rawdata), value = TRUE))
wastewater_sample_bl <- wastewater_sample_rawdata[, ..bl_cols]

# Here, we may have multiple rows per sample so fill in the id columns down for those samples, then convert - and + to 0 and 1.
wastewater_sample_bl[, (ww_id_cols) := lapply(.SD, na.locf), .SDcols = ww_id_cols]
pres_abs_cols <- bl_cols[!bl_cols %in% c(ww_id_cols, 'Bl_species')]
wastewater_sample_bl[, (pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = pres_abs_cols]

# Separate AR bacteria (E.coli, Salmonella, and MDR Enterococcus) into a separate dataframe
ar_pres_abs_cols <- c(grep('^AR_Ecoli', names(wastewater_sample_rawdata), value = TRUE), grep('^Salmonella', names(wastewater_sample_rawdata), value = TRUE), grep('^Enterococcus', names(wastewater_sample_rawdata), value = TRUE), 'ESBL', 'CRE')
ar_cols <- c(ww_id_cols, ar_pres_abs_cols)
wastewater_sample_ar <- wastewater_sample_rawdata[, ..ar_cols]

# Again, fill in the ID columns down for any samples with multiple rows, then convert - and + to 0 and 1.
wastewater_sample_ar[, (ww_id_cols) := lapply(.SD, na.locf), .SDcols = ww_id_cols]
wastewater_sample_ar[, (ar_pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = ar_pres_abs_cols]

```

```{r, eval = FALSE, echo = FALSE}
save_objs <- c("wastewater_sample_antibiotic_conc", 
"wastewater_sample_ar", "wastewater_sample_arg_copynum", "wastewater_sample_bl", 
"wastewater_sample_ecolicounts", 
"water_sample_antibiotic_conc", "water_sample_ar", "water_sample_arg_copynum", 
"water_sample_bl", "water_sample_environmental")

lapply(save_objs, function(x) fwrite(get(x), file.path('project/csv', paste0(x, '.csv'))))
```

## Exploratory data visualization

Here are some initial plots to take a look at what is going on with the data.

First reload the data that was processed previously to a clean and usable form. Also load the spatial data. Get rid of the temperature data point of 32C in winter that was probably measured in error.

```{r}
w_antibiotic_conc <- fread('project/csv/water_sample_antibiotic_conc.csv')
w_ar <- fread('project/csv/water_sample_ar.csv')
w_arg_copynum <- fread('project/csv/water_sample_arg_copynum.csv')
w_bl <- fread('project/csv/water_sample_bl.csv')
w_env <- fread('project/csv/water_sample_environmental.csv')
ww_antibiotic_conc <- fread('project/csv/wastewater_sample_antibiotic_conc.csv')
ww_ar <- fread('project/csv/wastewater_sample_ar.csv')
ww_arg_copynum <- fread('project/csv/wastewater_sample_arg_copynum.csv')
ww_bl <- fread('project/csv/wastewater_sample_bl.csv')
ww_env <- fread('project/csv/wastewater_sample_ecolicounts.csv')

w_id_cols <- c('sample_no', 'season', 'site', 'area')
ww_id_cols <- c('sample_no', 'season', 'site', 'type')

sites <- st_read('project/sites.gpkg')
watersheds <- st_read('project/study_region_huc12s.gpkg')

w_env[temperature >= 32, temperature := NA]
```

### Maps of environmental variables

The environmental variables may vary over time and space. Let's make some maps of these variables (potential predictor variables) to see how they might vary. Join the spatial and environmental data together.

```{r}
sites_env <- full_join(sites, w_env)

watersheds_proj <- st_transform(watersheds, crs = 26966) # Projection suitable for GA
```

Join AR presence absence data with environmental data. Reshape the data to long form for use later in model fitting.

```{r}
w_env_ar <- w_env[w_ar, on = w_id_cols]
season_order <- c('fall', 'winter', 'spring', 'summer')
w_env_ar[, season := factor(season, levels = season_order)]

w_ar_pres_abs <- melt(w_env_ar, id.vars = c(w_id_cols, 'temperature', 'pH', 'conductivity', 'turbidity', 'Ecoli_counts'), measure.vars = c('AR_Ecoli_presence', 'Salmonella_presence', 'Enterococcus_presence', 'ESBL', 'CRE'), variable.name = 'taxon', value.name = 'present')
w_ar_pres_abs[, taxon := gsub('_presence', '', taxon)]
```

Temperature appears to be higher in the SE part of the study area in summer. (High winter temperature measurement was removed.)

```{r, echo = FALSE}
theme_map <- theme(axis.text.x = element_blank(), axis.text.y = element_blank(),
                   axis.ticks.x = element_blank(), axis.ticks.y = element_blank())

ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = temperature), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'RdYlBu') +
  theme_map + theme(legend.position = 'bottom')
```

pH does not seem to have a strong spatial pattern but it does seem to be highest (most basic) in spring and lowest (most acidic) in winter.

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = pH), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'Reds', direction = 1) +
  theme_map + theme(legend.position = 'bottom')
```

Conductivity does not seem to vary much across the sites or seasons, so it is unlikely to explain much variation in any of the response variables. However there are some locations with very high conductivity values in winter.

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = conductivity), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'RdYlGn', direction = -1) +
  theme_map + theme(legend.position = 'bottom')
```

As you might expect, turbidity is low everywhere in fall and winter but increases at some locations in spring and summer (doesn't seem to have a lot of spatial pattern).

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = turbidity), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'RdYlGn', direction = -1) +
  theme_map + theme(legend.position = 'bottom')
```

Let's plot the *E. coli* counts too. I have used a (log+1) transform on the color scale. They do not seem to have an immediately obvious spatial pattern but they do decrease in winter, it seems like. That seems pretty plausible.

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = Ecoli_counts), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'Blues', direction = 1, trans = 'log1p', breaks = c(10, 100, 1000)) +
  theme_map + theme(legend.position = 'bottom')
```


### E. coli counts, environmental variables, and presence of AR taxa

Show seasonal trends in presence-absence of different AR taxa, ignoring environmental variables for now. Here we see that the counts of presences of AR *E. coli* and *Enterococcus* are relatively small so there is not very much basis to detect a trend. However for *Salmonella*  we see all but 1 of the 11 presences were from the fall. The majority of ESBL was observed in the winter, and CRE in the summer.

```{r, echo = FALSE}
orange_scale <- scale_fill_brewer(palette = 'Oranges', name = 'presence', labels = c('absent', 'present')) 
y_scale <- scale_y_continuous(expand = expansion(mult = c(0, 0.01)))
lpos <- theme(legend.position = c(0.85, 0.25))

ggplot(w_ar_pres_abs[!is.na(present) & !is.na(season)], aes(x = season, fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos
```

Let's also look at the relationship between different environmental predictors and taxa presence-absence. I will make bins to show the proportion presence at different ranges of different environmental variables.

The probability of presence for ESBL looks higher at low temperature which matches it being more common in winter. Same goes for *Salmonella* and fall.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(temperature)], aes(x = cut(temperature, breaks = c(4,10,16,22,28)), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'temperature') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Most of the pH values appear to be in a narrow range between 6.5 and 7.1 which makes sense. It does not seem that there is much of a pH trend for any taxon.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(pH)], aes(x = cut(pH, breaks = c(6.2, 6.5, 6.8, 7.1, 7.4, 7.7, 8)), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'pH') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Most turbidity values are on the low end and it does not look like the probability of presence of any taxon changes with turbidity. However this does indicate to me that maybe a log transformation of turbidity would reveal more of a pattern, because of the skewed distribution. (It will need to be a log+n transformation because of the zero values, probably I will add 1 to all).

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(turbidity)], aes(x = cut(turbidity, breaks = c(0, 10, 20, 30, 40), include.lowest = TRUE), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'turbidity') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Most conductivity values appear to be on the low end as well, so I will also plan to log transform those before analyzing.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(conductivity)], aes(x = cut(conductivity, breaks = 5), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'conductivity') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Finally, what about *E. coli* counts? I do not see a strong trend for any taxon. Possibly it may be a higher probability of AR *E. coli* if there are more *E. coli* overall, which I guess would be expected, but it does not seem like a strong trend.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(Ecoli_counts)], aes(x = cut(Ecoli_counts, breaks = c(0, 50, 100, 500, 1000, 5000), include.lowest = TRUE), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'E. coli count') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

## Statistical model

Now here is a statistical model where I try to account for a number of factors to see whether environmental factors (I am including *E. coli* counts in with the environmental factors) influence the joint presence and absence of different AR taxa. We will try to put all the AR taxa into one model as a multivariate response because the different environmental factors may affect their presence-absence probability similarly. Further, we will account for any seasonality in the data (currently, in a quick and dirty way by adding an additional categorical fixed effect for season to the model). Finally, we will account for the repeated measures structure of the data, where the data was sampled multiple times per site. We will not account for the spatial location of the different sites explicitly; instead, we will just give each site a random intercept.

At first, I thought about using `glmer()` to fit a generalized linear mixed model (GLMM) to each taxon separately. However I decided not to do this. First, those all would be separate models and do not account for the relationships between the different AR taxa, nor do they account for the "multiple comparisons" issue where we are testing the same predictors over and over to see if they affect different response variables. Second, several of the models result in singular fits. This means the data do not permit a good estimation of the random effects, so the maximum likelihood algorithm just "gives up" and calls all the random effects (site effects) zero. This is not ideal.

A superior way to do this is to fit a MGLMM (multivariate generalized linear mixed model) where we fit the presence/absence of all five AR taxa as the response variable, which will account for the interactions between them, as well as accounting for the multiple comparisons reasonably well. The classical or frequentist statistical tools we have available are not up to this task. Luckily we have a trick up our sleeve and we can use a Bayesian approach to set up this model with prior distributions on the different parameters and then sample from the posterior.

### Prepare the data

This takes the log+1 transformation for some of the predictors and then standardizes all of them which is a good practice for a multiple regression. Then the data is converted to a long form. I am following [the suggestion in this forum post](https://discourse.mc-stan.org/t/multivariate-glm-in-brms/11930/5) to convert the data to long form and include the interactions between taxon and the other predictors.

```{r}
scaled_predictors <- w_env_ar[, .(temperature, pH, conductivity, turbidity, Ecoli_counts)]
scaled_predictors[, Ecoli_counts := log1p(Ecoli_counts)]
scaled_predictors[, conductivity := log1p(conductivity)]
scaled_predictors[, turbidity := log1p(turbidity)]
scaled_predictors <- scale(scaled_predictors)

w_env_ar_model_data <- cbind(
  w_env_ar[, .(sample_no, season, site, AR_Ecoli_presence, Salmonella_presence, Enterococcus_presence, ESBL, CRE)],
  scaled_predictors)

w_env_ar_long <- melt(w_env_ar_model_data, measure.vars = c('AR_Ecoli_presence', 'Salmonella_presence',                   'Enterococcus_presence', 'ESBL', 'CRE'), variable.name = 'taxon', value.name = 'present')
w_env_ar_long[, taxon := gsub('_presence', '', taxon)]
```

### Fit the model

The fixed effects are the environmental predictors (including season) and the interaction between taxon and each predictor. The random effects are site and taxon nested within site. After compilation, the model samples in about 30 seconds on my laptop and converges well. Priors are included on the fixed effects to make plausible values more likely which helps the model converge.

```{r}
mv_ar_fit <- brm(
  bf(present ~ temperature + pH + conductivity + turbidity + Ecoli_counts + season + taxon:temperature + taxon:pH + taxon:conductivity + taxon:turbidity + taxon:Ecoli_counts + taxon:season + (1|site) + (1|taxon:site)), 
  data = w_env_ar_long, family = bernoulli,
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 71222,
  file = 'project/mv_ar_fit'
)
```

Quick convergence diagnostic: what is the maximum R-hat statistic? If it is close to 1 (<=1.01) the model has converged. Yes, it's good enough to say the model has converged on a solution and we can make inferences based on its output.

```{r}
max(rhat(mv_ar_fit))
```

Quick diagnostic to see if the model fits the data well: a posterior predictive check plot. If the thin blue lines (samples from the posterior distribution) match the thick black line (the data), it does. The eyeball test says: yes, it is a good fit.

```{r}
pp_check(mv_ar_fit)
```

## Examine model output

Now that we have this model and know that it has converged and is a good fit, we can play with the output and make whatever inference we want. The most interesting things to plot will be the parameter estimates on the interaction terms, and interaction plots showing a line for the probability of presence of each taxon, compared with a particular environmental factor. Note: the model doesn't account for any multi-way interactions between environmental predictors, for instance between taxon, temperature and pH. Those kind of interactions could be included, at the cost of having a really complicated model.

Generally, my take here is that the fitted trends are very "noisy." This means there is a lot of variability in presence-absence relative to the different environmental factors, and there is no really strong signal of an environmental relationship that rises above the noise in most cases. However in some cases there is weak evidence for a relationship.

My basic procedure here for looking at model results and making inference will be to plot the conditional effects for each environmental predictor by taxon. That will show the trend of how much each environmental variable predicts the probability of presence of each taxon, while holding all other predictors at their average values. I will plot the median of the posterior as the point estimate of effect size, and the 66% and 95% credible intervals (roughly +/-1 and +/-2 standard deviations, respectively).

An important point to note is that this is a Bayesian analysis, so we are moving away from the binary paradigm of statistical significance (question: Is there an effect of X on Y, yes or no?) and toward a paradigm of estimating *effect sizes* and their distributions (question: How big of an effect is there of X on Y, and how uncertain is our estimate of it?) In my opinion this is a better way to think about evidence because there is no such thing as yes or no, black and white answers in reality.

### Marginal effect trend plots

OK, so now that I have the philosophical stuff out of the way, let's look at the results. First, I will show plots of the fitted posterior estimated value of the trend, with the 66% and 95% credible intervals, for each combination of taxon and predictor variable. The log-transformed and standardized predictors are transformed back to their original scale, and the response variable is transformed to a probability scale ranging from 0 to 1.

It's important to note that these are *marginal effect* plots, in other words the effect of each individual predictor variable holding all the other ones constant at their average value. This also means averaging over all sites and all seasons' trends.

```{r, echo = FALSE}
scaled_centers <- attr(scaled_predictors, 'scaled:center')
scaled_scales <- attr(scaled_predictors, 'scaled:scale')

### Define function to construct marginal effect plots
plot_marginal_effect <- function(variable, n_x = 50, backtransform_log = FALSE, breaks_x) {
  x_range <- range(w_env_ar_long[[variable]], na.rm = TRUE)
  x_r_seq <- seq(x_range[1], x_range[2], length.out = n_x)
  x_r_seq_backtransformed <- scaled_scales[variable] * x_r_seq + scaled_centers[variable]
    if (backtransform_log) {
    x_r_seq_backtransformed <- expm1(x_r_seq_backtransformed)
    x_scale_trans <- 'log1p'
    } else {
    x_scale_trans <- 'identity'
  }
  
  pred_names <- c(variable, 'taxon')
  pred_dat <- expand.grid(x = x_r_seq, taxon = unique(w_env_ar_long$taxon)) |> setNames(pred_names)
  pred_dat_backtransformed <- expand.grid(x = x_r_seq_backtransformed, taxon = unique(w_env_ar_long$taxon)) 
  

  marginal_draws <- brmsmargins(mv_ar_fit, at = pred_dat)
  marginal_summ <- Rutilitybelt::pred_quantile(x_pred = pred_dat_backtransformed, y_pred = marginal_draws$Posterior)
  
  ggplot(marginal_summ, aes(x = x, y = q0.5, color = taxon, fill = taxon)) + 
    geom_ribbon(aes(ymin = q0.025, ymax = q0.975), alpha = 0.3, color = NA) + 
    geom_ribbon(aes(ymin = q0.17, ymax = q0.83), alpha = 0.3, color = NA) + 
    geom_line(size = 0.8) + 
    facet_wrap(~ taxon) +
    theme(legend.position = 'none') +
    scale_fill_brewer(palette = 'Dark2') + scale_color_brewer(palette = 'Dark2') +
    scale_x_continuous(name = variable, trans = x_scale_trans, breaks = breaks_x) +
    labs(y = 'modeled probability of presence')
}
```

The temperature trends plot shows fairly strong evidence that antibiotic-resistant *Salmonella* is more likely to be present at lower temperatures and almost completely absent at high water temperature. A similar but much weaker trend may exist for ESBL but the uncertainty is very high. The other AR taxa show no evidence for any response to temperature.

```{r, echo = FALSE}
plot_marginal_effect(variable = 'temperature', breaks_x = c(5, 10, 15, 20, 25))
```

The pH trends plot shows that antibiotic-resistant *E. coli* may be more likely to be present in lower-pH water samples although this is a fairly weak trend and the uncertainty is high. I would say none of the other taxa show any evidence for a pH response.

```{r, echo = FALSE}
plot_marginal_effect(variable = 'pH', breaks_x = c(6.5, 7, 7.5))
```

Turbidity does not show much of a response for any of the taxa, except possibly there is weak evidence that CRE is more likely to be present in more turbid water samples.

```{r, echo = FALSE}
plot_marginal_effect(variable = 'turbidity', backtransform_log = TRUE, breaks_x = c(0, 3, 10, 30))
```

The signal is weak and uncertainty high for conductivity response so I would not say there is much evidence for any response.

```{r, echo = FALSE}
plot_marginal_effect(variable = 'conductivity', backtransform_log = TRUE, breaks_x = c(50, 100, 500))
```

The presence of antibiotic-resistant *E. coli* is predicted fairly strongly by the *E. coli* counts in the water sample which is not surprising. However the other taxa do not show any evidence that they respond to that.

```{r, echo = FALSE}
plot_marginal_effect(variable = 'Ecoli_counts', backtransform_log = TRUE, breaks_x = c(3, 10, 30, 100, 300, 3000))
```

### Trend effect size plots

Now to make inferences based on those trends we can eyeball from the plots, let's estimate the marginal trend effect sizes (i.e. slopes) for each combination of taxon and predictor variable. These are displayed in both plot and table form. On the plot, the large point is the median estimate, the thick error bar is the 66% credible interval (about 1 standard deviation), and the thin error bar is the 95% credible interval (about 2 standard deviations).

```{r, echo = FALSE}
plot_emtrends <- function(variable) {
  trends <- emtrends(mv_ar_fit, ~ taxon, var = variable)
  trend_draws <- gather_emmeans_draws(trends)
  ggplot(trend_draws, aes(x = taxon, y = .value)) +
    stat_pointinterval() +
    geom_hline(yintercept = 0, linetype = 'dashed', color = 'slateblue', size = 1) +
    scale_y_continuous(name = 'estimated trend') +
    coord_flip() +
    ggtitle(paste(variable, 'trends by AR taxon')) +
    theme(axis.title.y = element_blank())
}
```

The temperature effect size plot confirms what we saw above, that *Salmonella* has a negative relationship so is more likely to be present in colder water samples, ESBL is maybe weakly associated with colder water but I would call it very weak evidence, and the other taxa are not.

```{r, echo = FALSE}
plot_emtrends(variable = 'temperature')
```

The pH effect size plot confirms there is decent evidence that AR *E. coli* is more likely to be present in more acidic water samples but other taxa are not responsive to pH.

```{r, echo = FALSE}
plot_emtrends(variable = 'pH')
```

The turbidity plot confirms most taxa do not change their probability of presence with changes in turbidity. The positive trend in CRE overlaps zero at 95% confidence by a large amount so is probably too weak of evidence to say much about.

```{r, echo = FALSE}
plot_emtrends(variable = 'turbidity')
```

The effect size plot for conductivity shows little response for any taxon.

```{r, echo = FALSE}
plot_emtrends(variable = 'conductivity')
```

The *E. coli* counts effect size plot confirms the positive response of probability of AR *E. coli* response to total *E. coli* and also confirms no other taxa's probability is predicted by that.

```{r, echo = FALSE}
plot_emtrends(variable = 'Ecoli_counts')
```

I also made a plot for each season separately. The uncertainty is very high for some of the taxa that are not present at all for a particular season, or only have one or two presences for that season. We can see that there are differences for some of the taxa for some of the seasons, notably ESBL is more likely to be present in winter than fall, and *Salmonella* more likely in fall than winter, however there is very high uncertainty in all the other taxa because of the low number of presences overall making it hard to fit the model.

```{r, echo = FALSE}
season_means <- emmeans(mv_ar_fit, ~ taxon + season, type = 'response')
season_mean_draws <- gather_emmeans_draws(season_means) %>%
  mutate(p = plogis(.value))

ggplot(season_mean_draws, aes(x = season, y = p)) +
  stat_pointinterval() +
  facet_wrap(~ taxon, scales = 'free_y') +
  labs(y = 'modeled probability of presence') +
  ggtitle('Marginal means for each season by AR taxon')
```

### Marginal trend effect size tables

Below is the same information from the effect size plots above, but in table form. Medians and four different quantile credible intervals (99%, 95%, 90%, and 66%) are provided. This emphasizes that 95% is not the only important one to look at although "traditionally" it is the only one reported in manuscripts.

```{r, echo = FALSE}
print_ci <- function(l, u, nsig = 3) glue('({signif(l, nsig)}, {signif(u, nsig)})') 

table_emtrends <- function(variable) {
  trends <- emtrends(mv_ar_fit, ~ taxon, var = variable)
  trend_quants <- Rutilitybelt::emm_quantile(trends)
  trend_quants %>%
    mutate(estimate = signif(q0.5, 3), ci99 = print_ci(q0.005, q0.995), ci95 = print_ci(q0.025, q0.975), ci90 = print_ci(q0.05, q0.95), ci66 = print_ci(q0.17, q0.83)) %>%
    select(taxon, estimate, ci99, ci95, ci90, ci66) %>%
    gt(caption = glue('Estimated marginal trends for {variable}')) %>%
    cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
    tab_options(column_labels.font.weight = 'bold')
}

table_emtrends(variable = 'temperature')
table_emtrends(variable = 'pH')
table_emtrends(variable = 'turbidity')
table_emtrends(variable = 'conductivity')
table_emtrends(variable = 'Ecoli_counts')

Rutilitybelt::emm_quantile(season_means) %>%
  arrange(season, taxon) %>%
  mutate(across(starts_with('q'), plogis)) %>%
  mutate(estimate = glue('{signif(q0.5, 3)}'), ci99 = print_ci(q0.005, q0.995), ci95 = print_ci(q0.025, q0.975), ci90 = print_ci(q0.05, q0.95), ci66 = print_ci(q0.17, q0.83)) %>%
  select(taxon, season, estimate, ci99, ci95, ci90, ci66) %>%
  group_by(taxon) %>%
  gt(caption = glue('Estimated marginal means by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(
    row_group.background.color = "#D4EBF2",
    row_group.font.weight = 'bold',
    column_labels.font.weight = 'bold'
  )
```

