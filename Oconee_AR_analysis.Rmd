---
title: "Upper Oconee AR analysis"
author: "Quentin D. Read"
date: "`r Sys.Date()`"
output: 
  html_document:
      css: "gtstyle.css"
      toc: true
      toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Summary

In this document, I put together the Upper Oconee data and got some external data to make maps. I also made some exploratory data analysis plots and then fit a formal statistical model. All of this focuses on Question 1 from your original list of research questions: do environmental factors influence the presence and absence of antibiotic resistant taxa? Basically, the answers are not that different from the analysis that the UGA statistician did, which is a great thing (it means the results are robust and patterns tend to come through regardless of what analysis is used) but on the other hand I also think there is now much more nuance.

I suppressed the display of some of the code but I kept some of the more important code displayed in here so that you can see what I did.

Note: I now use a model that accounts for the non-independence of observations from the same site and from the same time. However I did not actually incorporate the spatial locations of the sites into the model explicitly. I don't think that is worth the additional effort it would take, and is unlikely to show anything new. So the question moving forward is what to do next. I should hopefully ultimately have time to put this same approach toward the other parts of your research questions beyond Question 1, but I wanted to share this with you all first to get your opinion.

OK, let's get to it.

# Initial setup

## Processing the spatial data

The spatial data needed are:

- boundaries of the Upper Oconee watershed
- [National Land Cover Database (NLCD)](https://mrlc.gov/data) land cover type and impervious surface percentage raster data
- [National Hydrography Database (NHD)](https://www.usgs.gov/national-hydrography/access-national-hydrography-products) paths of streams and rivers in the watershed

[Main page for USGS hydrography data](https://www.usgs.gov/national-hydrography/access-national-hydrography-products)

To get the boundaries of the Upper Oconee, I looked up its [HUC8 watershed code](https://water.usgs.gov/lookup/getwatershed?03070101) which is `03070101`. I went to [this download page](https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Hydrography/WBD/HU2/GPKG/) and downloaded [this file of the HUC2 watershed boundaries for the Southeastern USA](https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/WBD/HU2/GPKG/WBD_03_HU2_GPKG.zip) and pulled out the polygon for the Upper Oconee (see below).

To get the NLCD land cover type and impervious surface rasters, I downloaded the data for the entire USA (large files) from [this MRLC download page](https://www.mrlc.gov/data?f%5B0%5D=year%3A2019). The specific files I downloaded were [this one for 2019 land cover](https://s3-us-west-2.amazonaws.com/mrlc/nlcd_2019_land_cover_l48_20210604.zip) and [this one for 2019 impervious surface](https://s3-us-west-2.amazonaws.com/mrlc/nlcd_2019_impervious_l48_20210604.zip).

To get the NHD stream and river paths, I went to [this download page](https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Hydrography/NHD/HU8/GPKG/) and downloaded [this file for the Upper Oconee HUC8 watershed](https://prd-tnm.s3.amazonaws.com/StagedProducts/Hydrography/NHD/HU8/GPKG/NHD_H_03070101_HU8_GPKG.zip).

Load the R packages.

```{r}
library(sf)
library(readxl)
library(dplyr)
library(tidyr)
library(data.table)
library(stringr)
library(zoo)
library(ggplot2)
library(lme4)
library(emmeans)
library(brms)
library(tidybayes)
library(brmsmargins)
library(gt)
library(glue)
library(cowplot)

theme_set(
  theme_bw() +
    theme(strip.background = element_blank(),
          panel.grid = element_blank())
)

options(mc.cores = 4, brms.backend = 'cmdstanr', brms.file_refit = 'on_change')
```

```{r, echo = FALSE}
# Define some variables and functions for later use
variables <- c('temperature', 'pH', 'turbidity', 'conductivity', 'Ecoli_counts')
blue_cols <- RColorBrewer::brewer.pal(3, "Blues")[1:2]

plot_marginal_effect <- function(variable, fit, y_label, n_x = 50, y_scale_trans = 'identity') {
  variable_scaled <- paste0(variable, '_scaled')
  x_range <- range(w_env_scaled[[variable]], na.rm = TRUE)
  x_r_seq <- seq(min(w_env_scaled[[variable_scaled]], na.rm = TRUE), max(w_env_scaled[[variable_scaled]], na.rm = TRUE), length.out = n_x)
  x_r_seq_backtransformed <- seq(min(w_env_scaled[[variable]], na.rm = TRUE), max(w_env_scaled[[variable]], na.rm = TRUE), length.out = n_x)
  x_scale_trans <- ifelse(variable %in% c('turbidity', 'conductivity', 'Ecoli_counts'), 'log1p', 'identity')

  pred_dat <- setNames(data.frame(x = x_r_seq), variable_scaled)
  pred_dat_backtransformed <- setNames(data.frame(x = x_r_seq_backtransformed), variable)
  
  marginal_draws <- brmsmargins(fit, at = pred_dat)
  marginal_summ <- Rutilitybelt::pred_quantile(x_pred = pred_dat_backtransformed, y_pred = marginal_draws$Posterior)
  
  ggplot(marginal_summ, aes(x = !!ensym(variable), y = q0.5)) + 
    geom_ribbon(aes(ymin = q0.025, ymax = q0.975), color = NA, fill = blue_cols[1]) + 
    geom_ribbon(aes(ymin = q0.17, ymax = q0.83), color = NA, fill = blue_cols[2]) + 
    geom_line(size = 0.8) + 
    theme(legend.position = 'none') +
    scale_fill_brewer(palette = 'Dark2') + scale_color_brewer(palette = 'Dark2') +
    scale_x_continuous(name = variable, trans = x_scale_trans, breaks = x_break_list[[variable]]) +
    scale_y_continuous(name = y_label, trans = y_scale_trans)
}

print_ci <- function(l, u, nsig = 3) glue('({signif(l, nsig)}, {signif(u, nsig)})') 
```


First load the coordinates and convert to a shapefile. Save as a GeoPackage shapefile for future use. Do the same for the boundary of the Upper Oconee watershed. Also get the smaller HUC12 watershed boundaries that are contained within the single boundary of the Upper Oconee. (Note: this portion of the code is not run when the notebook is created.)

```{r, eval = FALSE}
site_locs <- read_xlsx('project/AR paper_sampling sites_location.xlsx')
names(site_locs) <- c('site', 'lat', 'lon')

site_sp <- st_as_sf(site_locs, coords = c('lon', 'lat'), crs = st_crs('+proj=longlat')) %>%
  mutate(area = substr(site, 1, 4))

st_write(site_sp, 'project/sites.gpkg', driver = 'GPKG')

st_layers('~/spatial_data/WBD_03_HU2_GPKG.gpkg')
huc8s <- st_read(dsn = '~/spatial_data/WBD_03_HU2_GPKG.gpkg', layer = 'WBDHU8')
upper_oconee <- huc8s %>% filter(huc8 == '03070101')

st_write(upper_oconee, 'project/upper_oconee.gpkg', driver = 'GPKG')

huc12s <- st_read(dsn = '~/spatial_data/WBD_03_HU2_GPKG.gpkg', layer = 'WBDHU12')
upper_oconee_huc12s <- huc12s %>% filter(substr(huc12, 1, 8) == '03070101') %>%
  st_transform(crs = st_crs(site_sp))

# Get only the huc12s intersecting with the sites.
huc12s_use <- apply(st_intersects(upper_oconee_huc12s, site_sp, sparse = FALSE), 1, any)
st_write(upper_oconee_huc12s[huc12s_use,], 'project/study_region_huc12s.gpkg', driver = 'GPKG')
```

Transform watershed boundary shapefile to the same projection as the NLCD rasters so it can be used to crop them.

```{r, eval = FALSE}
library(stars)
nlcd <- read_stars('~/spatial_data/nlcd_2019_land_cover_l48_20210604.img')
upper_oconee <- st_read('project/upper_oconee.gpkg')
upper_oconee_AEA <- st_transform(upper_oconee, crs = st_crs(nlcd))
st_write(upper_oconee_AEA, 'project/upper_oconee_AEA.gpkg', driver = 'GPKG')
```

Finally, crop the NLCD raster to those boundaries. This is done with a shell script on SciNet because I do not have my local computer configured to use GDAL in this way.

```{bash, eval = FALSE}
module load gdal
cd /project/qdr/spatial

gdalwarp -crop_to_cutline -cutline upper_oconee_AEA.gpkg -of GTiff nlcd_2019_land_cover_l48_20210604.img nlcd_land_cover_upper_oconee.tif
gdalwarp -crop_to_cutline -cutline upper_oconee_AEA.gpkg -of GTiff nlcd_2019_impervious_l48_20210604.img nlcd_impervious_upper_oconee.tif
```

## Read and process raw data

Next, read the raw data in and convert it to a form usable for analysis and mapping. We will need to:

- Fill in environmental data covariates in cases where a sample has multiple isolates.
- Distinguish rows where species is `-` from rows where there is no data.
- Create separate datasets for environmental covariates, lactamase presence-absence, antibiotic concentrations, and ARG absolute and relative copy numbers that can be joined together later.

Some code here was copied from the UGA statistician's code. While looking at the UGA statistician's code I noticed that they removed any isolate beyond the first from the dataset from each sample. So that is probably not good. I have corrected this. (Code not shown here as it is very long.)

```{r, eval = FALSE, echo = FALSE}
water_sample_rawdata <- read_xlsx('project/AR paper_stat analysis_tables.xlsx', sheet = 'water samples', skip = 7) |> setDT()
wastewater_sample_rawdata <- read_xlsx('project/AR paper_stat analysis_tables.xlsx', sheet = 'wastewater samples', skip = 6) |> setDT()

# Column names created by UGA statistician
correct_names_watersample = c("sample_no", 'season', 'site', 
                              'temperature','pH','conductivity','turbidity','Ecoli_counts',
                              'Bl_species',
                              'Bl_Amp','Bl_Faz','Bl_Fep','Bl_Fot','Bl_Fox','Bl_Pod','Bl_Taz','Bl_Axo','Bl_Cep','Bl_Cip','Bl_Gen','Bl_Imi','Bl_P_T4','Bl_Mer',
                              'Bl_blaCTX_M','Bl_blaTEM','Bl_blaCMY_2','Bl_blaSHV','Bl_blaOXA','Bl_blaIMI_NmcA','Bl_blaKPC',
                              'ESBL','CRE',
                              'AR_Ecoli_presence',
                              'AR_Ecoli_Amo_Cla','AR_Ecoli_Amp','AR_Ecoli_Azi','AR_Ecoli_Chl','AR_Ecoli_Fox','AR_Ecoli_Tio','AR_Ecoli_Axo','AR_Ecoli_Cip','AR_Ecoli_Gen','AR_Ecoli_Nal','AR_Ecoli_Str','AR_Ecoli_Sul','AR_Ecoli_Tet','AR_Ecoli_Tri_Smx',
                              'Salmonella_presence',
                              'Salmonella_Amo_Cla','Salmonella_Amp','Salmonella_Fox','Salmonella_Tio','Salmonella_Axo','Salmonella_Chl','Salmonella_Gen','Salmonella_Str','Salmonella_Sul','Salmonella_Tet',
                              'Enterococcus_presence',
                              'Enterococcus_Cip','Enterococcus_Dap','Enterococcus_Ery','Enterococcus_Lin','Enterococcus_Nit','Enterococcus_Pen','Enterococcus_Str','Enterococcus_Syn','Enterococcus_Tet','Enterococcus_Tyl',
                              'Amo','Amp','Azi','Axo','Taz','Tio','Cip','Dap','Ery','Gen','Kan','Lin','Lnz','Mer','Met','Nal',
                              'Oxa','Pen','Smx','Sul','Str','Tig','Tri','Tet','Tyl','Van','total',
                              'abs_ermB','abs_tetB','abs_blaKPC','abs_blaSHV','abs_qnrS','abs_blaCTX-M','abs_total',
                              'rlt_ermB','rlt_tetB','rlt_blaKPC','rlt_blaSHV','rlt_qnrS','rlt_blaCTX-M','rlt_total'
)

setnames(water_sample_rawdata, correct_names_watersample)
water_sample_rawdata[, area := substr(site, 1, 4)]
water_sample_rawdata[, season := tolower(season)]

# Create environmental dataframe with no duplicated rows
id_cols <- c(correct_names_watersample[1:3], 'area')
env_cols <- c(id_cols, correct_names_watersample[4:8])

water_sample_environmental <- water_sample_rawdata[, ..env_cols]
water_sample_environmental <- water_sample_environmental[!is.na(sample_no) & !duplicated(sample_no)]

# Separate the column with AR salmonella presence and number of isolates combined into one column into two separate columns
water_sample_rawdata[, Salmonella_n_isolates := as.numeric(str_extract(Salmonella_presence, '[0-9]'))]
water_sample_rawdata[, Salmonella_presence := substr(Salmonella_presence, 1, 1)]

# Separate antibiotic concentrations into a separate dataframe
antibiotic_conc_idx <- which(names(water_sample_rawdata) == 'Amo'):which(names(water_sample_rawdata) == 'total')
antibiotic_conc_cols <- c(id_cols, names(water_sample_rawdata)[antibiotic_conc_idx])

# Here also get rid of the duplicated rows
water_sample_antibiotic_conc <- water_sample_rawdata[, ..antibiotic_conc_cols]
water_sample_antibiotic_conc <- water_sample_antibiotic_conc[!is.na(sample_no) & !duplicated(sample_no)]

# Separate ARG copy numbers into a separate dataframe
arg_copy_cols <- c(id_cols, grep('(^abs)|(^rlt)', names(water_sample_rawdata), value = TRUE))

# Again, get rid of the duplicated rows
water_sample_arg_copynum <- water_sample_rawdata[, ..arg_copy_cols]
water_sample_arg_copynum <- water_sample_arg_copynum[!is.na(sample_no) & !duplicated(sample_no)]

# Separate beta-lactamase into a separate dataframe
bl_cols <- c(id_cols, grep('^Bl_', names(water_sample_rawdata), value = TRUE))
water_sample_bl <- water_sample_rawdata[, ..bl_cols]

# Here, we may have multiple rows per sample so fill in the id columns down for those samples, then convert - and + to 0 and 1.
water_sample_bl[, (id_cols) := lapply(.SD, na.locf), .SDcols = id_cols]
pres_abs_cols <- bl_cols[!bl_cols %in% c(id_cols, 'Bl_species')]
water_sample_bl[, (pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = pres_abs_cols]

# Separate AR bacteria (E.coli, Salmonella, and MDR Enterococcus) into a separate dataframe
ar_pres_abs_cols <- c(grep('^AR_Ecoli', names(water_sample_rawdata), value = TRUE), grep('^Salmonella', names(water_sample_rawdata), value = TRUE), grep('^Enterococcus', names(water_sample_rawdata), value = TRUE), 'ESBL', 'CRE')
ar_cols <- c(id_cols, ar_pres_abs_cols)
water_sample_ar <- water_sample_rawdata[, ..ar_cols]

# Edit 13 July: condense presence absence for samples with multiple rows to 1 if present in any isolate, 0 otherwise.
water_sample_ar[, (id_cols) := lapply(.SD, na.locf), .SDcols = id_cols]
water_sample_ar[, (ar_pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = ar_pres_abs_cols]
water_sample_ar <- water_sample_ar[, lapply(.SD, \(x) as.numeric(any(x))), by = id_cols, .SDcols = ar_pres_abs_cols]
```

```{r, eval = FALSE, echo = FALSE}
correct_names_wastewater = c("sample_no", 'season', 'site', 'Ecoli_counts',
                             'Bl_species',
                             'Bl_Amp','Bl_Faz','Bl_Fep','Bl_Fot','Bl_Fox','Bl_Pod','Bl_Taz','Bl_Axo','Bl_Cep','Bl_Cip','Bl_Gen','Bl_Imi','Bl_P_T4','Bl_Mer',
                             'Bl_blaCTX_M','Bl_blaTEM','Bl_blaCMY_2','Bl_blaSHV','Bl_blaOXA','Bl_blaIMI_NmcA','Bl_blaKPC',
                             'ESBL','CRE',
                             'AR_Ecoli_presence',
                             'AR_Ecoli_Amo_Cla','AR_Ecoli_Amp','AR_Ecoli_Azi','AR_Ecoli_Fox','AR_Ecoli_Tio','AR_Ecoli_Axo','AR_Ecoli_Cip','AR_Ecoli_Gen','AR_Ecoli_Nal','AR_Ecoli_Str','AR_Ecoli_Sul','AR_Ecoli_Tet','AR_Ecoli_Tri_Smx',
                             'Salmonella_presence',
                             'Salmonella_Str','Salmonella_Tet',
                             'Enterococcus_presence',
                             'Enterococcus_Cip','Enterococcus_Dap','Enterococcus_Ery','Enterococcus_Lin','Enterococcus_Nit','Enterococcus_Pen','Enterococcus_Str','Enterococcus_Syn','Enterococcus_Tet','Enterococcus_Tyl',
                             'Amo','Amp','Azi','Axo','Taz','Tio','Cip','Dap','Ery','Gen','Kan','Lin','Lnz','Mer','Met','Nal',
                             'Oxa','Pen','Smx','Sul','Str','Tig','Tri','Tet','Tyl','Van','total',
                             'abs_ermB','abs_tetB','abs_blaKPC','abs_blaSHV','abs_qnrS','abs_blaCTX-M','abs_total',
                             'rlt_ermB','rlt_tetB','rlt_blaKPC','rlt_blaSHV','rlt_qnrS','rlt_blaCTX-M','rlt_total'
)

# Correct names and create indicator column for influent versus effluent
setnames(wastewater_sample_rawdata, correct_names_wastewater)
wastewater_sample_rawdata <- separate(wastewater_sample_rawdata, site, into = c('site', 'type'), sep = ' ')
wastewater_sample_rawdata[, season := tolower(season)]

ww_id_cols <- c('sample_no', 'season', 'site', 'type')

# Create data frame with just ecoli counts that can be used as a key to join all the other ones together
ecoli_cols <- c(ww_id_cols, 'Ecoli_counts')
wastewater_sample_ecolicounts <- wastewater_sample_rawdata[, ..ecoli_cols]
wastewater_sample_ecolicounts <- wastewater_sample_ecolicounts[!is.na(sample_no) & !duplicated(sample_no)]

# Separate the column with AR salmonella presence and number of isolates combined into one column into two separate columns
wastewater_sample_rawdata[, Salmonella_n_isolates := as.numeric(str_extract(Salmonella_presence, '[0-9]'))]
wastewater_sample_rawdata[, Salmonella_presence := substr(Salmonella_presence, 1, 1)]

# Separate antibiotic concentrations into a separate dataframe
antibiotic_conc_idx <- which(names(wastewater_sample_rawdata) == 'Amo'):which(names(wastewater_sample_rawdata) == 'total')
antibiotic_conc_cols <- c(ww_id_cols, names(wastewater_sample_rawdata)[antibiotic_conc_idx])

# Here also get rid of the duplicated rows
wastewater_sample_antibiotic_conc <- wastewater_sample_rawdata[, ..antibiotic_conc_cols]
wastewater_sample_antibiotic_conc <- wastewater_sample_antibiotic_conc[!is.na(sample_no) & !duplicated(sample_no)]

# Separate ARG copy numbers into a separate dataframe
arg_copy_cols <- c(ww_id_cols, grep('(^abs)|(^rlt)', names(wastewater_sample_rawdata), value = TRUE))

# Again, get rid of the duplicated rows
wastewater_sample_arg_copynum <- wastewater_sample_rawdata[, ..arg_copy_cols]
wastewater_sample_arg_copynum <- wastewater_sample_arg_copynum[!is.na(sample_no) & !duplicated(sample_no)]

# Separate beta-lactamase into a separate dataframe
bl_cols <- c(ww_id_cols, grep('^Bl_', names(water_sample_rawdata), value = TRUE))
wastewater_sample_bl <- wastewater_sample_rawdata[, ..bl_cols]

# Here, we may have multiple rows per sample so fill in the id columns down for those samples, then convert - and + to 0 and 1.
wastewater_sample_bl[, (ww_id_cols) := lapply(.SD, na.locf), .SDcols = ww_id_cols]
pres_abs_cols <- bl_cols[!bl_cols %in% c(ww_id_cols, 'Bl_species')]
wastewater_sample_bl[, (pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = pres_abs_cols]

# Separate AR bacteria (E.coli, Salmonella, and MDR Enterococcus) into a separate dataframe
ar_pres_abs_cols <- c(grep('^AR_Ecoli', names(wastewater_sample_rawdata), value = TRUE), grep('^Salmonella', names(wastewater_sample_rawdata), value = TRUE), grep('^Enterococcus', names(wastewater_sample_rawdata), value = TRUE), 'ESBL', 'CRE')
ar_cols <- c(ww_id_cols, ar_pres_abs_cols)
wastewater_sample_ar <- wastewater_sample_rawdata[, ..ar_cols]

# Again, fill in the ID columns down for any samples with multiple rows, then convert - and + to 0 and 1.
wastewater_sample_ar[, (ww_id_cols) := lapply(.SD, na.locf), .SDcols = ww_id_cols]
wastewater_sample_ar[, (ar_pres_abs_cols) := lapply(.SD, function(x) as.numeric(x == '+')), .SDcols = ar_pres_abs_cols]
wastewater_sample_ar <- wastewater_sample_ar[, lapply(.SD, \(x) as.numeric(any(x))), by = ww_id_cols, .SDcols = ar_pres_abs_cols]
```

```{r, eval = FALSE, echo = FALSE}
save_objs <- c("wastewater_sample_antibiotic_conc", 
"wastewater_sample_ar", "wastewater_sample_arg_copynum", "wastewater_sample_bl", 
"wastewater_sample_ecolicounts", 
"water_sample_antibiotic_conc", "water_sample_ar", "water_sample_arg_copynum", 
"water_sample_bl", "water_sample_environmental")

lapply(save_objs, function(x) fwrite(get(x), file.path('project/csv', paste0(x, '.csv'))))
```

# Question 1. Do environmental factors predict AR taxa, AR genes, or antibiotic concentrations?

First I am going to make some initial plots to take a look at what is going on with the data for Question 1.

Reload the data that was processed previously to a clean and usable form. Also load the spatial data. Get rid of the temperature data point of 32C in winter that was probably measured in error.

```{r}
w_antibiotic_conc <- fread('project/csv/water_sample_antibiotic_conc.csv')
w_ar <- fread('project/csv/water_sample_ar.csv')
w_arg_copynum <- fread('project/csv/water_sample_arg_copynum.csv')
w_bl <- fread('project/csv/water_sample_bl.csv')
w_env <- fread('project/csv/water_sample_environmental.csv')
ww_antibiotic_conc <- fread('project/csv/wastewater_sample_antibiotic_conc.csv')
ww_ar <- fread('project/csv/wastewater_sample_ar.csv')
ww_arg_copynum <- fread('project/csv/wastewater_sample_arg_copynum.csv')
ww_bl <- fread('project/csv/wastewater_sample_bl.csv')
ww_env <- fread('project/csv/wastewater_sample_ecolicounts.csv')

w_id_cols <- c('sample_no', 'season', 'site', 'area')
ww_id_cols <- c('sample_no', 'season', 'site', 'type')

sites <- st_read('project/sites.gpkg')
watersheds <- st_read('project/study_region_huc12s.gpkg')

w_env[temperature >= 32, temperature := NA]
season_order <- c('fall', 'winter', 'spring', 'summer')
w_env[, season := factor(season, levels = season_order)]
```

## Maps of environmental variables

The environmental variables may vary over time and space. Let's make some maps of these variables (potential predictor variables) to see how they might vary. Join the spatial and environmental data together.

```{r}
sites_env <- full_join(sites, w_env)

watersheds_proj <- st_transform(watersheds, crs = 26966) # Projection suitable for GA
```

Join AR presence absence data with environmental data. Reshape the data to long form for use later in model fitting.

```{r}
w_env_ar <- w_env[w_ar, on = w_id_cols]
w_env_ar[, season := factor(season, levels = season_order)]

w_ar_pres_abs <- melt(w_env_ar, id.vars = c(w_id_cols, 'temperature', 'pH', 'conductivity', 'turbidity', 'Ecoli_counts'), measure.vars = c('AR_Ecoli_presence', 'Salmonella_presence', 'Enterococcus_presence', 'ESBL', 'CRE'), variable.name = 'taxon', value.name = 'present')
w_ar_pres_abs[, taxon := gsub('_presence', '', taxon)]
```

Temperature appears to be higher in the SE part of the study area in summer. (High winter temperature measurement was removed.)

```{r, echo = FALSE}
theme_map <- theme(axis.text.x = element_blank(), axis.text.y = element_blank(),
                   axis.ticks.x = element_blank(), axis.ticks.y = element_blank())

ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = temperature), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'RdYlBu') +
  theme_map + theme(legend.position = 'bottom')
```

pH does not seem to have a strong spatial pattern but it does seem to be highest (most basic) in spring and lowest (most acidic) in winter.

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = pH), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'Reds', direction = 1) +
  theme_map + theme(legend.position = 'bottom')
```

Conductivity does not seem to vary much across the sites or seasons, so it is unlikely to explain much variation in any of the response variables. However there are some locations with very high conductivity values in winter.

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = conductivity), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'RdYlGn', direction = -1) +
  theme_map + theme(legend.position = 'bottom')
```

As you might expect, turbidity is low everywhere in fall and winter but increases at some locations in spring and summer (doesn't seem to have a lot of spatial pattern).

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = turbidity), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'RdYlGn', direction = -1) +
  theme_map + theme(legend.position = 'bottom')
```

Let's plot the *E. coli* counts too. I have used a (log+1) transform on the color scale. They do not seem to have an immediately obvious spatial pattern but they do decrease in winter, it seems like. That seems pretty plausible.

```{r, echo = FALSE}
ggplot() +
  geom_sf(data = watersheds_proj, alpha = 0.3) +
  geom_sf(data = sites_env, aes(fill = Ecoli_counts), shape = 21, size = 2) +
  facet_wrap(~ season) +
  scale_fill_distiller(palette = 'Blues', direction = 1, trans = 'log1p', breaks = c(10, 100, 1000)) +
  theme_map + theme(legend.position = 'bottom')
```


## Graphs of presence of AR taxa vs. environmental variables

Show seasonal trends in presence-absence of different AR taxa averaged across other environmental variables. Here we see that the counts of presences of AR *E. coli* and *Enterococcus* are relatively small so there is not very much basis to detect a trend. However for *Salmonella*  we see all but 1 of the 11 presences were from the fall. The majority of ESBL was observed in the winter, and CRE in the summer.

```{r, echo = FALSE}
orange_scale <- scale_fill_brewer(palette = 'Oranges', name = 'presence', labels = c('absent', 'present')) 
y_scale <- scale_y_continuous(expand = expansion(mult = c(0, 0.01)))
lpos <- theme(legend.position = c(0.85, 0.25))

ggplot(w_ar_pres_abs[!is.na(present) & !is.na(season)], aes(x = season, fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos
```

Let's also look at the relationship between different environmental predictors and taxa presence-absence. I will make bins to show the proportion presence at different ranges of different environmental variables.

The probability of presence for ESBL looks higher at low temperature which matches it being more common in winter. Same goes for *Salmonella* and fall.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(temperature)], aes(x = cut(temperature, breaks = c(4,10,16,22,28)), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'temperature') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Most of the pH values appear to be in a narrow range between 6.5 and 7.1 which makes sense. It does not seem that there is much of a pH trend for any taxon.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(pH)], aes(x = cut(pH, breaks = c(6.2, 6.5, 6.8, 7.1, 7.4, 7.7, 8)), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'pH') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Most turbidity values are on the low end and it does not look like the probability of presence of any taxon changes with turbidity. However this does indicate to me that maybe a log transformation of turbidity would reveal more of a pattern, because of the skewed distribution. (It will need to be a log+n transformation because of the zero values, probably I will add 1 to all).

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(turbidity)], aes(x = cut(turbidity, breaks = c(0, 10, 20, 30, 40), include.lowest = TRUE), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'turbidity') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Most conductivity values appear to be on the low end as well, so I will also plan to log transform those before analyzing.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(conductivity)], aes(x = cut(conductivity, breaks = 5), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'conductivity') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Finally, what about *E. coli* counts? I do not see a strong trend for any taxon. Possibly it may be a higher probability of AR *E. coli* if there are more *E. coli* overall, which I guess would be expected, but it does not seem like a strong trend.

```{r, echo = FALSE}
ggplot(w_ar_pres_abs[!is.na(present) & !is.na(Ecoli_counts)], aes(x = cut(Ecoli_counts, breaks = c(0, 50, 100, 500, 1000, 5000), include.lowest = TRUE), fill = factor(present))) +
  geom_bar() +
  facet_wrap(~ taxon) +
  orange_scale + y_scale + lpos +
  labs(x = 'E. coli count') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

## Analysis for questions 1a-1j: AR presence-absence versus environmental variables

### Description of statistical model

Now here is a statistical model where I try to account for a number of factors to see whether environmental factors (I am including *E. coli* counts in with the environmental factors) influence the joint presence and absence of different AR taxa. We will try to put all the AR taxa into one model as a multivariate response because the different environmental factors may affect their presence-absence probability similarly. Further, we will account for any seasonality in the data (currently, in a quick and dirty way by adding an additional categorical fixed effect for season to the model). Finally, we will account for the repeated measures structure of the data, where the data was sampled multiple times per site. We will not account for the spatial location of the different sites explicitly; instead, we will just give each site a random intercept.

At first, I thought about using `glmer()` to fit a generalized linear mixed model (GLMM) to each taxon separately. However I decided not to do this. First, those all would be separate models and do not account for the relationships between the different AR taxa, nor do they account for the "multiple comparisons" issue where we are testing the same predictors over and over to see if they affect different response variables. Second, several of the models result in singular fits. This means the data do not permit a good estimation of the random effects, so the maximum likelihood algorithm just "gives up" and calls all the random effects (site effects) zero. This is not ideal.

A superior way to do this is to fit a MGLMM (multivariate generalized linear mixed model) where we fit the presence/absence of all five AR taxa as the response variable, which will account for the interactions between them, as well as accounting for the multiple comparisons reasonably well. The classical or frequentist statistical tools we have available are not up to this task. Luckily we have a trick up our sleeve and we can use a Bayesian approach to set up this model with prior distributions on the different parameters and then sample from the posterior.

### Prepare the data

This takes the log+1 transformation for some of the predictors and then standardizes all of them which is a good practice for a multiple regression. Then the data is converted to a long form. I am following [the suggestion in this forum post](https://discourse.mc-stan.org/t/multivariate-glm-in-brms/11930/5) to convert the data to long form and include the interactions between taxon and the other predictors.

```{r}
# Scale predictors in environmental dataset.
scale_predictors <- function(DT) {
  DTscale <- DT[, .(temperature, pH, conductivity, turbidity, Ecoli_counts)]
  DTscale[, Ecoli_counts := log1p(Ecoli_counts)]
  DTscale[, conductivity := log1p(conductivity)]
  DTscale[, turbidity := log1p(turbidity)]
  setnames(DTscale, paste0(names(DTscale), '_scaled'))
  scale(DTscale)
}

scaled_predictors <- scale_predictors(w_env)
scaled_centers <- attr(scaled_predictors, 'scaled:center')
scaled_scales <- attr(scaled_predictors, 'scaled:scale')

w_env_scaled <- cbind(w_env, scaled_predictors)

w_env_ar <- w_env_scaled[w_ar, on = w_id_cols]
w_env_ar[, season := factor(season, levels = season_order)]

w_env_ar_long <- melt(w_env_ar, measure.vars = c('AR_Ecoli_presence', 'Salmonella_presence', 'Enterococcus_presence', 'ESBL', 'CRE'), variable.name = 'taxon', value.name = 'present')
w_env_ar_long[, taxon := gsub('_presence', '', taxon)]
```

### Fit the model

The fixed effects are the environmental predictors (including season) and the interaction between taxon and each predictor. The random effects are site and taxon nested within site. After compilation, the model samples in about 30 seconds on my laptop and converges well. Priors are included on the fixed effects to make plausible values more likely which helps the model converge.

```{r}
mv_ar_fit <- brm(
  bf(present ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + taxon:temperature_scaled + taxon:pH_scaled + taxon:conductivity_scaled + taxon:turbidity_scaled + taxon:Ecoli_counts_scaled + taxon:season + (1|site) + (1|taxon:site)), 
  data = w_env_ar_long, family = bernoulli,
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 71222,
  file = 'project/mv_ar_fit'
)
```

Quick convergence diagnostic: what is the maximum R-hat statistic? If it is close to 1 (<=1.01) the model has converged. Yes, it's good enough to say the model has converged on a solution and we can make inferences based on its output.

```{r}
max(rhat(mv_ar_fit))
```

Quick diagnostic to see if the model fits the data well: a posterior predictive check plot. If the black points with error bars (samples from the posterior distribution) match the blue bars (the data), it does. The eyeball test says: yes, it is a good fit.

```{r}
pp_check(mv_ar_fit, type = 'bars', ndraws = 100)
```

### Examine model output

Now that we have this model and know that it has converged and is a good fit, we can play with the output and make whatever inference we want. The most interesting things to plot will be the parameter estimates on the interaction terms, and interaction plots showing a line for the probability of presence of each taxon, compared with a particular environmental factor. Note: the model doesn't account for any multi-way interactions between environmental predictors, for instance between taxon, temperature and pH. Those kind of interactions could be included, at the cost of having a really complicated model.

Generally, my take here is that the fitted trends are very "noisy." This means there is a lot of variability in presence-absence relative to the different environmental factors, and there is no really strong signal of an environmental relationship that rises above the noise in most cases. However in some cases there is weak evidence for a relationship.

My basic procedure here for looking at model results and making inference will be to plot the conditional effects for each environmental predictor by taxon. That will show the trend of how much each environmental variable predicts the probability of presence of each taxon, while holding all other predictors at their average values. I will plot the median of the posterior as the point estimate of effect size, and the 66% and 95% credible intervals (roughly +/-1 and +/-2 standard deviations, respectively).

An important point to note is that this is a Bayesian analysis, so we are moving away from the binary paradigm of statistical significance (question: Is there an effect of X on Y, yes or no?) and toward a paradigm of estimating *effect sizes* and their distributions (question: How big of an effect is there of X on Y, and how uncertain is our estimate of it?) In my opinion this is a better way to think about evidence because there is no such thing as yes or no, black and white answers in reality.

### Marginal effect trend plots

OK, so now that I have the philosophical stuff out of the way, let's look at the results. First, I will show plots of the fitted posterior estimated value of the trend, with the 66% and 95% credible intervals, for each combination of taxon and predictor variable. The log-transformed and standardized predictors are transformed back to their original scale, and the response variable is transformed to a probability scale ranging from 0 to 1.

It's important to note that these are *marginal effect* plots, in other words the effect of each individual predictor variable holding all the other ones constant at their average value. This also means averaging over all sites and all seasons' trends.

```{r, echo = FALSE}
### Define function to construct marginal effect plots
plot_marginal_effect_bytaxon <- function(variable, n_x = 50, backtransform_log = FALSE, breaks_x) {
  variable_scaled <- paste0(variable, '_scaled')
  x_r_seq <- seq(min(w_env_ar_long[[variable_scaled]], na.rm = TRUE), max(w_env_ar_long[[variable_scaled]], na.rm = TRUE), length.out = n_x)
  x_r_seq_backtransformed <- seq(min(w_env_ar_long[[variable]], na.rm = TRUE), max(w_env_ar_long[[variable]], na.rm = TRUE), length.out = n_x)
  x_scale_trans <- ifelse(backtransform_log, 'log1p', 'identity')
    
  pred_names <- c(variable_scaled, 'taxon')
  pred_dat <- expand.grid(x = x_r_seq, taxon = unique(w_env_ar_long$taxon)) |> setNames(pred_names)
  pred_dat_backtransformed <- expand.grid(x = x_r_seq_backtransformed, taxon = unique(w_env_ar_long$taxon)) 
  
  marginal_draws <- brmsmargins(mv_ar_fit, at = pred_dat)
  marginal_summ <- Rutilitybelt::pred_quantile(x_pred = pred_dat_backtransformed, y_pred = marginal_draws$Posterior)
  
  ggplot(marginal_summ, aes(x = x, y = q0.5, color = taxon, fill = taxon)) + 
    geom_ribbon(aes(ymin = q0.025, ymax = q0.975), alpha = 0.3, color = NA) + 
    geom_ribbon(aes(ymin = q0.17, ymax = q0.83), alpha = 0.3, color = NA) + 
    geom_line(size = 0.8) + 
    facet_wrap(~ taxon) +
    theme(legend.position = 'none') +
    scale_fill_brewer(palette = 'Dark2') + scale_color_brewer(palette = 'Dark2') +
    scale_x_continuous(name = variable, trans = x_scale_trans, breaks = breaks_x) +
    labs(y = 'modeled probability of presence')
}

x_break_list <- list(
  temperature = c(5, 10, 15, 20, 25),
  pH = c(6.5, 7, 7.5),
  turbidity = c(0, 3, 10, 30),
  conductivity = c(50, 100, 500),
  Ecoli_counts = c(3, 10, 30, 100, 300, 3000)
)
```

The temperature trends plot shows fairly strong evidence that antibiotic-resistant *Salmonella* is more likely to be present at lower temperatures and almost completely absent at high water temperature. A similar but much weaker trend may exist for ESBL but the uncertainty is very high. The other AR taxa show no evidence for any response to temperature.

```{r, echo = FALSE}
plot_marginal_effect_bytaxon(variable = 'temperature', breaks_x = x_break_list[['temperature']])
```

The pH trends plot shows that antibiotic-resistant *E. coli* may be more likely to be present in lower-pH water samples although this is a fairly weak trend and the uncertainty is high. I would say none of the other taxa show any evidence for a pH response.

```{r, echo = FALSE}
plot_marginal_effect_bytaxon(variable = 'pH', breaks_x = x_break_list[['pH']])
```

Turbidity does not show much of a response for any of the taxa, except possibly there is weak evidence that CRE is more likely to be present in more turbid water samples.

```{r, echo = FALSE}
plot_marginal_effect_bytaxon(variable = 'turbidity', backtransform_log = TRUE, breaks_x = x_break_list[['turbidity']])
```

The signal is weak and uncertainty high for conductivity response so I would not say there is much evidence for any response.

```{r, echo = FALSE}
plot_marginal_effect_bytaxon(variable = 'conductivity', backtransform_log = TRUE, breaks_x = x_break_list[['conductivity']])
```

The presence of antibiotic-resistant *E. coli* is predicted fairly strongly by the *E. coli* counts in the water sample which is not surprising. However the other taxa do not show any evidence that they respond to that.

```{r, echo = FALSE}
plot_marginal_effect_bytaxon(variable = 'Ecoli_counts', backtransform_log = TRUE, breaks_x = x_break_list[['Ecoli_counts']])
```

### Trend effect size plots

Now to make inferences based on those trends we can eyeball from the plots, let's estimate the marginal trend effect sizes (i.e. slopes) for each combination of taxon and predictor variable. These are displayed in both plot and table form. On the plot, the large point is the median estimate, the thick error bar is the 66% credible interval (about 1 standard deviation), and the thin error bar is the 95% credible interval (about 2 standard deviations).

```{r, echo = FALSE}
plot_emtrends_bytaxon <- function(variable) {
  variable_scaled <- paste0(variable, '_scaled')
  trends <- emtrends(mv_ar_fit, ~ taxon, var = variable_scaled)
  trend_draws <- gather_emmeans_draws(trends)
  ggplot(trend_draws, aes(x = taxon, y = .value)) +
    stat_interval(.width = c(.66, .95)) +
    stat_summary(fun = median, geom = 'point', size = 2) +
    scale_color_brewer(palette = 'Blues', name = 'credible interval') +
    geom_hline(yintercept = 0, linetype = 'dashed', color = 'slateblue', size = 1) +
    scale_y_continuous(name = 'estimated trend') +
    coord_flip() +
    ggtitle(paste(variable, 'trends by AR taxon')) +
    theme(axis.title.y = element_blank(), legend.position = 'bottom')
}
```

The temperature effect size plot confirms what we saw above, that *Salmonella* has a negative relationship so is more likely to be present in colder water samples, and the other taxa do not have any particular association with colder or warmer water.

```{r, echo = FALSE}
plot_emtrends_bytaxon(variable = 'temperature')
```

The pH effect size plot confirms there is decent evidence that AR *E. coli* is more likely to be present in more acidic water samples but other taxa are not responsive to pH.

```{r, echo = FALSE}
plot_emtrends_bytaxon(variable = 'pH')
```

The turbidity plot confirms most taxa do not change their probability of presence with changes in turbidity. The positive trend in CRE overlaps zero at 95% confidence by a large amount so is probably too weak of evidence to say much about.

```{r, echo = FALSE}
plot_emtrends_bytaxon(variable = 'turbidity')
```

The effect size plot for conductivity shows little response for any taxon.

```{r, echo = FALSE}
plot_emtrends_bytaxon(variable = 'conductivity')
```

The *E. coli* counts effect size plot confirms the positive response of probability of AR *E. coli* response to total *E. coli* and also confirms no other taxa's probability is predicted by that.

```{r, echo = FALSE}
plot_emtrends_bytaxon(variable = 'Ecoli_counts')
```

I also made a plot for each season separately. The uncertainty is very high for some of the taxa that are not present at all for a particular season, or only have one or two presences for that season. We can see that there are differences for some of the taxa for some of the seasons, notably ESBL is more likely to be present in winter than fall, and *Salmonella* more likely in fall than winter, however there is very high uncertainty in all the other taxa because of the low number of presences overall making it hard to fit the model.

```{r, echo = FALSE}
season_means <- emmeans(mv_ar_fit, ~ taxon + season, type = 'response')
season_mean_draws <- gather_emmeans_draws(season_means) %>%
  mutate(p = plogis(.value))

ggplot(season_mean_draws, aes(x = season, y = p)) +
  stat_interval(.width = c(.66, .95)) +
  stat_summary(fun = median, geom = 'point', size = 2) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  facet_wrap(~ taxon, scales = 'free_y') +
  labs(y = 'modeled probability of presence') +
  ggtitle('Marginal means for each season by AR taxon') +
  theme(legend.position = c(0.85, 0.2))
```

### Marginal trend effect size tables

Below is the same information from the effect size plots above, but in table form. Medians and four different quantile credible intervals (99%, 95%, 90%, and 66%) are provided. This emphasizes that 95% is not the only important one to look at although "traditionally" it is the only one reported in manuscripts.

```{r, echo = FALSE}
table_emtrends <- function(variable, fit) {
  trends <- emtrends(fit, ~ taxon, var = paste0(variable, '_scaled'))
  trend_quants <- Rutilitybelt::emm_quantile(trends)
  trend_quants %>%
    mutate(estimate = signif(q0.5, 3), ci99 = print_ci(q0.005, q0.995), ci95 = print_ci(q0.025, q0.975), ci90 = print_ci(q0.05, q0.95), ci66 = print_ci(q0.17, q0.83)) %>%
    select(taxon, estimate, ci99, ci95, ci90, ci66) %>%
    gt(caption = glue('Estimated marginal trends for {variable}')) %>%
    cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
    tab_options(column_labels.font.weight = 'bold')
}

table_emtrends(variable = 'temperature', fit = mv_ar_fit)
table_emtrends(variable = 'pH', fit = mv_ar_fit)
table_emtrends(variable = 'turbidity', fit = mv_ar_fit)
table_emtrends(variable = 'conductivity', fit = mv_ar_fit)
table_emtrends(variable = 'Ecoli_counts', fit = mv_ar_fit)

Rutilitybelt::emm_quantile(season_means) %>%
  arrange(season, taxon) %>%
  mutate(across(starts_with('q'), plogis)) %>%
  mutate(estimate = glue('{signif(q0.5, 3)}'), ci99 = print_ci(q0.005, q0.995), ci95 = print_ci(q0.025, q0.975), ci90 = print_ci(q0.05, q0.95), ci66 = print_ci(q0.17, q0.83)) %>%
  select(taxon, season, estimate, ci99, ci95, ci90, ci66) %>%
  group_by(taxon) %>%
  gt(caption = glue('Estimated marginal means by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(
    row_group.background.color = "#D4EBF2",
    row_group.font.weight = 'bold',
    column_labels.font.weight = 'bold'
  )
```

## Analysis for question 1k: Presence of Beta-lactamase gene-containing bacteria

First, let's make a table of how many of each taxon are present. The majority of the taxa present are *Serratia*. Because there are so few presences for the other taxa, I don't think it would be that informative to do the categorical regression where we look at each one separately. So I decided to lump everything together and just look at presence of any beta-lactamase-containing bacterial taxon versus having none at all, for each water sample.

```{r}
w_env_bl <- w_env_scaled[w_bl, on = w_id_cols]
w_env_bl[, season := factor(season, levels = season_order)]

w_env_bl <- w_env_bl[!Bl_species %in% '']
w_env_bl[Bl_species == '-', Bl_species := 'none']
w_env_bl[, Bl_species := relevel(factor(Bl_species), ref = 'none')]

table(w_env_bl$Bl_species) 
```

I combined the data and scaled the predictors appropriately.

```{r}
# Put together the data for the present absent regression
w_env_bl_presabs <- w_env_bl[, .(Bl_present = any(Bl_species != 'none')), by = c(w_id_cols, variables, paste0(variables, '_scaled'))]

# One-hot encoding for the Bl_species column for the multinomial model
Bl_species_matrix <- data.table(ID = 1:nrow(w_env_bl), sp = w_env_bl$Bl_species) |>
  dcast(ID ~ sp, length)
Bl_species_matrix[, ID := NULL]
#w_env_bl[, Bl_species_matrix := do.call(cbind, Bl_species_matrix)]
```

### Fit statistical model

Here is a statistical model for predicting the probability of presence of at least one of any kind of beta-lactamase-containing bacterium in a water sample, based on the same environmental factors as before. It is a logistic regression because the outcome is binary (either yes, there is one, or no there is not).

```{r}
bl_bern_fit <- brm(
  bf(Bl_present ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_bl_presabs, family = bernoulli(link = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 70924,
  file = 'project/bl_bern_fit'
)
```

The model converges well and fits the data well too as this plot shows (the predicted values are black points with error bars, that line up well with the actual data which are the counts of absence = 0 and presence = 1).

```{r}
pp_check(bl_bern_fit, type="bars", ndraws = 100)
```

### Examine model output

Plot the parameter estimates from the model. Mainly this shows that there are large seasonal differences in presence of beta-lac containing bacteria. Other trends are weak.

```{r, echo = FALSE}
# Plot parameter estimates from Bernoulli fit. We don't have separate ones by taxon so this is simpler.
bl_bern_slopes <- bl_bern_fit %>%
  gather_draws(`b_.*`, regex = TRUE) %>%
  filter(!.variable %in% 'b_Intercept') %>%
  mutate(.variable = gsub('b_', '', .variable),
         .variable = gsub('_scaled', '', .variable))

# Weak evidence for a positive pH trend, where there is more likelihood to be a beta-lac bacterium where it is more basic. 
# Also varies by season 
ggplot(bl_bern_slopes, aes(y = .variable, x = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_pointinterval(geom = "point", size = 2) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  geom_vline(xintercept = 0, linetype = 'dotted', color = 'gray50') +
  labs(x = 'parameter estimate') +
  theme(axis.title.y = element_blank(), legend.position = c(0.8, 0.2))
```

Next, plot marginal trends for each of the continuous predictors and marginal means for seasons. You can see a mild hint of a trend with pH but otherwise season is the strongest predictor.

```{r, echo = FALSE}
bl_bern_marginal_plots <- lapply(variables, plot_marginal_effect, fit = bl_bern_fit, y_label = 'modeled probability of any beta-lactamase presence')

# Plot marginal means for each season
bl_bern_season_means <- emmeans(bl_bern_fit, ~ season) %>%
  gather_emmeans_draws() %>%
  mutate(.value = plogis(.value))

bl_bern_season_plot <- ggplot(bl_bern_season_means, aes(x = season, y = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_pointinterval(geom = "point", size = 2) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  labs(y = 'modeled probability of any beta-lactamase presence') +
  theme(legend.position = c(0.2, 0.8))

plot_grid(plotlist = c(bl_bern_marginal_plots, list(bl_bern_season_plot)), nrow = 3)
```

### Trend effect size tables

Below is the same information from the effect size plots above, but in table form. As above, medians and four different quantile credible intervals (99%, 95%, 90%, and 66%) are provided.

```{r, echo = FALSE}
bl_bern_slopes %>%
  filter(!grepl('season', .variable)) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(.variable, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(.variable, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Estimated environmental effects on beta-lactamase presence')) %>%
  cols_label(.variable = 'variable', ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

bl_bern_season_means %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(season, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(season, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Estimated mean beta-lactamase presence by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')
```

*note*: I am not currently including results for the categorical model. If you decide that it is important to look at presence-absence of specific taxa of beta-lactamase gene-containing bacteria, please let me know and I can work up those results. However, because the majority of the beta-lactamase bacteria were *Serratia* and there were only a handful of other ones, the results for *Serratia* will be similar to the overall results. The results for the rarer taxa will show at best weak evidence for any environmental associations because there are so few presences to fit the model on.

## Analysis for question 1l: Copy numbers of antibiotic resistance genes

I am going to use the conclusion made by the UGA statistician that the absolute and relative copy numbers basically have the same distribution so it does not matter which one you analyze. I will use the absolute copy numbers. Here are some plots to show this. First process the data.

```{r}
w_env_arg_cn <- w_env_scaled[w_arg_copynum, on = w_id_cols]
w_env_arg_cn[, season := factor(season, levels = season_order)]

# Visualize distributions of the different ARGs, ignoring predictors.
arg_abs_names <- grep('^abs', names(w_arg_copynum), value = TRUE)
arg_rlt_names <- grep('^rlt', names(w_arg_copynum), value = TRUE)
w_env_arg_long <- melt(w_env_arg_cn, id.vars = w_id_cols, measure.vars = c(arg_abs_names, arg_rlt_names), variable.name = 'ARG', value.name = 'copy_number') %>%
  separate(ARG, into = c('type', 'ARG'), sep = '_') %>%
  dcast(sample_no + season + site + area + ARG ~ type)
```

The absolute and relative look about the same. They also have a skewed distribution with all non-negative values but a lot of 0 values. So a hurdle model is needed that fits a gamma or lognormal distribution and also has a separate component for the probability of having 0. In other words, we first model the probability of there being 0 copies, then if there are >0, model the number of copies. We are only going to work with the total number of copies across all genes because most of the individual genes have so few that it will be hard to fit a model to them.

```{r, echo = FALSE}
ggplot(w_env_arg_long, aes(x = abs)) +
  geom_density() +
  facet_wrap(~ ARG, scales = 'free') +
  scale_x_continuous(trans = 'pseudo_log', breaks = c(0, 1, 10, 100, 1000))

ggplot(w_env_arg_long, aes(x = rlt)) +
  geom_density() +
  facet_wrap(~ ARG, scales = 'free') +
  scale_x_continuous(trans = 'pseudo_log', breaks = c(0, 0.001, 0.01, 0.1))
```

### Fit statistical model

I am trying out a hurdle gamma and hurdle lognormal model. For each distribution, one of the models has an additional component that allows the probability of exactly zero to vary as a function of all the random and fixed effects. 

```{r}
arg_cn_hugamma_fit <- brm(
  bf(abs_total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_arg_cn, family = hurdle_gamma(link = 'log', link_shape = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 71422,
  file = 'project/arg_cn_hugamma_fit'
)

arg_cn_hugamma_variablehu_fit <- brm(
  bf(abs_total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site),
     hu ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_arg_cn, family = hurdle_gamma(link = 'log', link_shape = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 71421,
  file = 'project/arg_cn_hugamma_variablehurdle_fit'
)

arg_cn_hulognorm_fit <- brm(
  bf(abs_total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_arg_cn, family = hurdle_lognormal(link = 'identity', link_sigma = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 71423,
  file = 'project/arg_cn_hulognorm_fit'
)

arg_cn_hulognorm_variablehu_fit <- brm(
  bf(abs_total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site),
     hu ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_arg_cn, family = hurdle_lognormal(link = 'identity', link_sigma = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 71424,
  file = 'project/arg_cn_hulognorm_variablehu_fit'
)
```

Model comparison is used to determine which model is best. The hurdle-gamma model is best but there is really no difference between the model with additional parameters and the simpler one, so we will keep the simpler one.

```{r}
arg_cn_hugamma_fit <- add_criterion(arg_cn_hugamma_fit, 'loo', moment_match = TRUE)
arg_cn_hugamma_variablehu_fit <- add_criterion(arg_cn_hugamma_variablehu_fit, 'loo', moment_match = TRUE)
arg_cn_hulognorm_fit <- add_criterion(arg_cn_hulognorm_fit, 'loo', moment_match = TRUE)
arg_cn_hulognorm_variablehu_fit <- add_criterion(arg_cn_hulognorm_variablehu_fit, 'loo', moment_match = TRUE)

loo_compare(arg_cn_hugamma_fit, arg_cn_hulognorm_fit, arg_cn_hugamma_variablehu_fit, arg_cn_hulognorm_variablehu_fit)
```

The model we selected as "best" looks like it fits the data reasonably well (not perfectly though), but the more complex one does not appear to be any better so that's another reason to stick with the relatively simple one.

```{r}
pp_check(arg_cn_hugamma_fit) + scale_x_log10()
pp_check(arg_cn_hugamma_variablehu_fit) + scale_x_log10()
```

### Examine model output

Plot the parameter estimates. Here we see pretty decent evidence that there is a negative pH trend so that more ARG copy numbers are found in more acidic samples, as well as solid evidence that more ARG copy numbers are found in samples with higher counts of *E. coli*. The seasonal trends do not look as strong as for some of the other response variables.

```{r, echo = FALSE}
arg_cn_slopes <- arg_cn_hugamma_fit %>%
  gather_draws(`b_.*`, regex = TRUE) %>%
  filter(!.variable %in% 'b_Intercept') %>%
  mutate(.variable = gsub('b_', '', .variable)) %>%
  mutate(.variable = gsub('_scaled', '', .variable))

# We see decent evidence for a negative pH trend (more ARG copy numbers in acidic water)
# and a positive Ecoli trend (more ARG copy numbers in samples with more Ecoli)
# conductivity may also show a positive trend.
ggplot(arg_cn_slopes, aes(y = .variable, x = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_pointinterval(geom = "point", size = 2) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  geom_vline(xintercept = 0, linetype = 'dotted', color = 'gray50') +
  labs(x = 'parameter estimate') +
  theme(axis.title.y = element_blank(), legend.position = c(0.85, 0.15))
```

Next, plot the marginal trends for each of the continuous predictors, and the marginal means for the seasons. 

```{r, echo = FALSE}
# Plot marginal effects for each of the continuous predictors
arg_cn_marginal_plots <- lapply(variables, plot_marginal_effect, fit = arg_cn_hugamma_fit, y_label = 'modeled total AR gene copy numbers', y_scale_trans = 'log10')

# Plot marginal means for each season
arg_cn_season_means <- emmeans(arg_cn_hugamma_fit, ~ season) %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value))

arg_cn_season_plot <- ggplot(arg_cn_season_means, aes(x = season, y = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_pointinterval(geom = "point", size = 2) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'modeled total AR gene copy numbers') +
  theme(legend.position = 'none') 

plot_grid(plotlist = c(arg_cn_marginal_plots, list(arg_cn_season_plot)), nrow = 3)
```

### Trend effect size tables

Below is the same information from the effect size plots above, but in table form. As above, medians and four different quantile credible intervals (99%, 95%, 90%, and 66%) are provided.

```{r, echo = FALSE}
arg_cn_slopes %>%
  filter(!grepl('season', .variable)) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(.variable, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(.variable, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Estimated environmental effects on ARG copy numbers')) %>%
  cols_label(.variable = 'variable', ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

arg_cn_season_means %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(season, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(season, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Estimated mean ARG copy numbers by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')
```


## Analysis for question 1m: antibiotic concentrations

First let's prepare the data and take a look at the distributions of each of the antibiotic concentrations. Use a pseudo-log transformation on the x-axis so we can see the spread of values on a log scale but also see the zero values. They are all non-negative (positive values with zeros).

```{r}
w_env_ant_conc <- w_env_scaled[w_antibiotic_conc, on = w_id_cols]
w_env_ant_conc[, season := factor(season, levels = season_order)]

# Visualize distributions of the different antibiotics, ignoring predictors.

antibiotic_names <- setdiff(names(w_antibiotic_conc), w_id_cols)
w_env_ant_conc_long <- melt(w_env_ant_conc, id.vars = w_id_cols, measure.vars = antibiotic_names, variable.name = 'antibiotic', value.name = 'concentration')
```

As with the AR gene copy number analysis above, we see that there are a lot of different individual antibiotics but probably insufficient data to look at the relationship between environmental variables and any one specific antibiotic. Therefore we will look at the total antibiotic concentration. Again because it is positive values with zeros mixed in, we will use a hurdle model, either hurdle gamma or hurdle lognormal. 

```{r, echo = FALSE}
# Pseudolog is used to keep zeroes in
ggplot(w_env_ant_conc_long, aes(x = concentration)) +
  geom_density() +
  facet_wrap(~ antibiotic, scales = 'free_y') +
  scale_x_continuous(trans = 'pseudo_log', breaks = c(0, 1, 10, 100, 1000))
```

### Fit statistical model

As we did in part 1L above, we will fit a hurdle-gamma and hurdle-lognormal model, each with and without some additional parameters to make the proportion of zeroes either fixed or variable by treatment. Then we will use model comparison to see which is the best fit to the data.

```{r}
ant_conc_hugamma_fit <- brm(
  bf(total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_ant_conc, family = hurdle_gamma(link = 'log', link_shape = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 70922,
  file = 'project/ant_conc_hugamma_fit'
)

ant_conc_hugamma_variablehu_fit <- brm(
  bf(total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site),
     hu ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_ant_conc, family = hurdle_gamma(link = 'log', link_shape = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 70921,
  file = 'project/ant_conc_hugamma_variablehu_fit'
)

ant_conc_hulognorm_fit <- brm(
  bf(total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_ant_conc, family = hurdle_lognormal(link = 'identity', link_sigma = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 70920,
  file = 'project/ant_conc_hulognorm_fit'
)

ant_conc_hulognorm_variablehu_fit <- brm(
  bf(total ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site),
     hu ~ temperature_scaled + pH_scaled + conductivity_scaled + turbidity_scaled + Ecoli_counts_scaled + season + (1|site)), 
  data = w_env_ant_conc, family = hurdle_lognormal(link = 'identity', link_sigma = 'log', link_hu = 'logit'),
  prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 70923,
  file = 'project/ant_conc_hulognorm_variablehu_fit'
)
```

As before, the gamma model is best and the simpler model is a little better than the more complex one that allows the probability of exactly zero to vary more. So we will go with that model.

```{r}
ant_conc_hugamma_fit <- add_criterion(ant_conc_hugamma_fit, 'loo', moment_match = TRUE)
ant_conc_hugamma_variablehu_fit <- add_criterion(ant_conc_hugamma_variablehu_fit, 'loo', moment_match = TRUE)
ant_conc_hulognorm_fit <- add_criterion(ant_conc_hulognorm_fit, 'loo', moment_match = TRUE)
ant_conc_hulognorm_variablehu_fit <- add_criterion(ant_conc_hulognorm_variablehu_fit, 'loo', moment_match = TRUE)

loo_compare(ant_conc_hugamma_fit, ant_conc_hugamma_variablehu_fit, ant_conc_hulognorm_fit, ant_conc_hulognorm_variablehu_fit) 

```

The posterior predictive check diagnostic looks pretty good for the simpler model.

```{r}
pp_check(ant_conc_hugamma_fit) + scale_x_log10()
pp_check(ant_conc_hugamma_variablehu_fit) + scale_x_log10()
```

### Examine model output

Plot parameter estimates. There is essentially no trend for any of the predictor variables except for seasonal differences.

```{r, echo = FALSE}
# Plot parameter estimates from hurdle gamma fit. We don't have separate ones by taxon so this is simpler.
ant_conc_slopes <- ant_conc_hugamma_fit %>%
  gather_draws(`b_.*`, regex = TRUE) %>%
  filter(!.variable %in% 'b_Intercept') %>%
  mutate(.variable = gsub('b_', '', .variable)) %>%
  mutate(.variable = gsub('_scaled', '', .variable))

# Essentially no trend except for differences between seasons.
ggplot(ant_conc_slopes, aes(y = .variable, x = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_pointinterval(geom = "point", size = 2) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  geom_vline(xintercept = 0, linetype = 'dotted', color = 'gray50') +
  labs(x = 'parameter estimate') +
  theme(axis.title.y = element_blank(), legend.position = c(0.85, 0.15))
```

Plot the marginal trends for each continuous predictor, and the means for the seasons. Again, we see evidence for seasonal difference but basically none for the other predictors having any effect.

```{r, echo = FALSE}
ant_conc_marginal_plots <- lapply(variables, plot_marginal_effect, fit = ant_conc_hugamma_fit, y_label = 'modeled total antibiotic concentration', y_scale_trans = 'log10')

# Plot marginal means for each season
ant_conc_season_means <- emmeans(ant_conc_hugamma_fit, ~ season) %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value))

ant_conc_season_plot <- ggplot(ant_conc_season_means, aes(x = season, y = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_pointinterval(geom = "point", size = 2) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'modeled total antibiotic concentration') +
  theme(legend.position = c(0.1, 0.8))

plot_grid(plotlist = c(ant_conc_marginal_plots, list(ant_conc_season_plot)), nrow = 3)
```

### Trend effect size tables

Below is the same information from the effect size plots above, but in table form. As above, medians and four different quantile credible intervals (99%, 95%, 90%, and 66%) are provided.

```{r, echo = FALSE}
ant_conc_slopes %>%
  filter(!grepl('season', .variable)) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(.variable, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(.variable, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Estimated environmental effects on antibiotic concentration')) %>%
  cols_label(.variable = 'variable', ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ant_conc_season_means %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(season, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(season, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Estimated mean antibiotic concentration by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')
```

# Wastewater samples

## Analysis for questions 2a-f. Change in presence of different AR taxa in influent versus effluent

Now let's look at question 2. First, for the presence-absence questions in influent versus effluent, let's make some tables. Here, you could suppose that the wastewater treatment was effective if the taxon is present in influent but absent in effluent. If it is absent in both, that is fine. If it is present in both, the treatment was ineffective. If it is absent in influent but present in effluent, that is a bad sign because either it was not detected in the influent or somehow was added through the treatment process! We do observe that in some cases.

```{r}
ww_ar_pa <- ww_ar[, .(season, site, type, AR_Ecoli_presence, Salmonella_presence, Enterococcus_presence, ESBL, CRE)]
taxa_names <- c('Ecoli', 'Salmonella', 'Enterococcus', 'ESBL', 'CRE')
setnames(ww_ar_pa, c('season', 'site', 'type', taxa_names))

ww_ar_pa[, (taxa_names) := lapply(.SD, function(x) ifelse(x, 'present', 'absent')), .SDcols = taxa_names]
ww_ar_pa[, (taxa_names) := lapply(.SD, factor, levels = c('absent', 'present')), .SDcols = taxa_names]

ww_ar_pa_wide <- dcast(ww_ar_pa, season + site ~ type, value.var = taxa_names)

with(ww_ar_pa_wide, table(Ecoli_influent, Ecoli_effluent))
with(ww_ar_pa_wide, table(Salmonella_influent, Salmonella_effluent))
with(ww_ar_pa_wide, table(Enterococcus_influent, Enterococcus_effluent))
with(ww_ar_pa_wide, table(ESBL_influent, ESBL_effluent))
with(ww_ar_pa_wide, table(CRE_influent, CRE_effluent))
```

Honestly, I do not really think this can be pursued further with statistics. Yes, you could do statistical tests on it, but it is not recommended that the chi-squared test be used if *any* of the values in the four cells of the 2x2 contingency table are <5. We do not have even a single value of 5 or greater for any of the cells across all five of these tables. I do not think the UGA statistician did this correctly because they did not account for the paired samples. It would be required to use a McNemar Chi-squared test in that case, I believe.

Also make a table for beta-lactamase gene-containing bacteria (if any are present at all).

```{r}
ww_bl_pa <- ww_bl[, .(Bl = ifelse(any(Bl_species != '-'), 'present', 'absent')), by = .(season, site, type)]
ww_bl_sp_wide <- dcast(ww_bl_pa, season + site ~ type)

with(ww_bl_sp_wide, table(influent, effluent))
```

Here, the same issue appears where we have too little data.

## Analysis for questions 2g-j. Change in ARG concentrations in influent vs. effluent

I agree with the UGA statistician that question 2g does not have enough data to answer. I will skip to question 2h because this is basically the same question but taking advantage of the continuous variable of copy numbers instead of reducing it down to a presence-absence question.

However I am doing this as a pre-post design that takes into account the non-independence of seasons and sites, because I think it is a better way of doing it. Also, let's fit everything in one model too.

Reshape the copy number data to a better format.

```{r}
ww_arg_copynum[, id := factor(rep(1:12, each = 2))]
ww_arg_long <- melt(ww_arg_copynum, id.vars = c('id', 'sample_no', 'season', 'site', 'type'), value.name = 'copy_num')
ww_arg_long <- separate(ww_arg_long, variable, into = c('count_type', 'gene'), sep = '_')

ww_arg_abs <- ww_arg_long[count_type == 'abs']
ww_arg_rlt <- ww_arg_long[count_type == 'rlt']
```

### Fit statistical models

The models include main effects for influent/effluent, season, and which AR gene it is, and interactions between influent/effluent x gene, and influent/effluent x season. There is a random intercept for each ID (combination of season and site). There are no data for summer so we are distinguishing three season effects.

```{r}
ww_arg_abs_fit <- brm(
  copy_num ~ type + season + gene + gene:type + season:type + (1|id:site),
   data = ww_arg_abs[!gene %in% 'total'], family = hurdle_gamma(link = 'log', link_shape = 'log', link_hu = 'logit'),
   prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 72722,
  file = 'project/ww_arg_abs_fit'
)

ww_arg_rlt_fit <- brm(
  copy_num ~ type + season + gene + gene:type + season:type + (1|id:site),
   data = ww_arg_rlt[!gene %in% 'total'], family = hurdle_gamma(link = 'log', link_shape = 'log', link_hu = 'logit'),
   prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 72723,
  file = 'project/ww_arg_rlt_fit'
)
```

As usual check convergence and do a posterior predictive check, for both the absolute and relative models. All looks good.

```{r}
max(rhat(ww_arg_abs_fit))
max(rhat(ww_arg_rlt_fit))
pp_check(ww_arg_abs_fit) + scale_x_log10()
pp_check(ww_arg_rlt_fit) + scale_x_log10()
```

### Estimated marginal mean and contrast plots

Calculate and plot estimated marginal means for the absolute and relative ARG copy numbers. We will show the overall effect of influent vs. effluent (question 2j, for absolute only as it doesn't make sense to do it for relative), and show the effects separately for each season and for each gene. Also, plot contrasts within season and within gene.

The wastewater treatment greatly reduces the absolute copy numbers of the AR genes, but it does not change the relative copy numbers as much. We have evidence for this effect in all genes. Interestingly, the strength of the effect differs somewhat by season. The wastewater treatment does a "better job" removing AR genes in winter.

```{r, echo = FALSE}
ww_arg_abs_emm_season <- emmeans(ww_arg_abs_fit, ~ type | season, type = 'response')
ww_arg_abs_emm_gene <- emmeans(ww_arg_abs_fit, ~ type | gene, type = 'response')
ww_arg_abs_emm_overall <- emmeans(ww_arg_abs_fit, ~ type, type = 'response')

ww_arg_rlt_emm_season <- emmeans(ww_arg_rlt_fit, ~ type | season, type = 'response')
ww_arg_rlt_emm_gene <- emmeans(ww_arg_rlt_fit, ~ type | gene, type = 'response')

ww_arg_abs_contr_gene <- contrast(ww_arg_abs_emm_gene, 'pairwise')
ww_arg_abs_contr_season <- contrast(ww_arg_abs_emm_season, 'pairwise')
ww_arg_abs_contr_overall <- contrast(ww_arg_abs_emm_overall, 'pairwise')

ww_arg_rlt_contr_gene <- contrast(ww_arg_rlt_emm_gene, 'pairwise')
ww_arg_rlt_contr_season <- contrast(ww_arg_rlt_emm_season, 'pairwise')

pd <- position_dodge(width = 0.3)

# Plots by gene ID
ww_arg_gene_type_means <- ww_arg_abs_emm_gene %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value)) %>%
  mutate(type = factor(type, levels = c('influent', 'effluent')))

ww_arg_overall_means <- ww_arg_abs_emm_overall %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value)) %>%
  mutate(type = factor(type, levels = c('influent', 'effluent')), gene = 'OVERALL')

ggplot(bind_rows(ww_arg_gene_type_means, ww_arg_overall_means) %>%
         mutate(gene = factor(gene, levels = c('OVERALL', as.character(unique(ww_arg_gene_type_means$gene))))),
       aes(x = gene, group = interaction(gene, type), y = .value)) +
  stat_interval(.width = c(0.66, 0.95), position = pd) +
  stat_summary(aes(shape = type), fun = median, geom = "point", size = 2, position = pd) +
  geom_vline(xintercept = 1.5) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'modeled absolute ARG copy numbers') +
  theme(legend.position = c(0.65, 0.15), legend.box = 'horizontal')

ww_rlt_gene_type_means <- ww_arg_rlt_emm_gene %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value)) %>%
  mutate(type = factor(type, levels = c('influent', 'effluent')))

ggplot(ww_rlt_gene_type_means, aes(x = gene, group = interaction(gene, type), y = .value)) +
  stat_interval(.width = c(0.66, 0.95), position = pd) +
  stat_summary(aes(shape = type), fun = median, geom = "point", size = 2, position = pd) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'modeled relative ARG copy numbers') +
  theme(legend.position = c(0.65, 0.15), legend.box = 'horizontal')

# Plots by season, absolute only
ww_arg_season_type_means <- ww_arg_abs_emm_season %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value), 
         season = factor(season, levels = c('fall', 'winter', 'spring')),
         type = factor(type, levels = c('influent', 'effluent'))) 

ggplot(ww_arg_season_type_means, aes(x = season, group = interaction(season, type), y = .value)) +
  stat_interval(.width = c(0.66, 0.95), position = pd) +
  stat_summary(aes(shape = type), fun = median, geom = "point", size = 2, position = pd) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'modeled absolute ARG copy numbers') +
  theme(legend.position = c(0.2, 0.15), legend.box = 'horizontal')
```

The contrast plots show that after wastewater treatment, each AR gene is reduced to something like 1% to 3% of its original absolute copy numbers (with some uncertainty around those estimates); the overall effect is reducing copy numbers to 2% of the original. In winter, almost all of the copy numbers are removed (less than 1% remain after treatment) but in fall and spring the treatment is not as effective. In fact in spring the 95% credible interval overlaps 100%, meaning we do not even have good evidence that wastewater treatment removes any AR gene copies at all in the spring. I do not know how to interpret that result. It may be a result due to small sample size, but maybe you all have a good explanation for that pattern. (The relative changes are small.)

```{r, echo = FALSE}
ww_arg_abs_contr_gene_draws <- ww_arg_abs_contr_gene %>%
  gather_emmeans_draws() %>%
  mutate(copy_numbers = 'absolute')

ww_arg_abs_contr_overall_draws <- ww_arg_abs_contr_overall %>%
  gather_emmeans_draws() %>%
  mutate(copy_numbers = 'absolute', gene = 'OVERALL')

ww_arg_rlt_contr_gene_draws <- ww_arg_rlt_contr_gene %>%
  gather_emmeans_draws() %>%
  mutate(copy_numbers = 'relative')

ggplot(rbind(ww_arg_abs_contr_gene_draws, ww_arg_abs_contr_overall_draws, ww_arg_rlt_contr_gene_draws) %>% mutate(.value = exp(.value), gene = factor(gene, levels = c('OVERALL', as.character(unique(ww_arg_gene_type_means$gene))))), 
       aes(x = gene,  y = .value)) +
  facet_wrap(~ copy_numbers, scales = 'free') +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_summary(fun = median, geom = "point", size = 2) +
  geom_hline(yintercept = 1, linetype = 'dotted', color = 'gray50') +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'effluent/influent ratio') +
  theme(legend.position = c(0.2, 0.15), legend.box = 'horizontal') +
  ggtitle('effluent:influent ARG copy number ratio by gene')

ww_arg_abs_contr_season_draws <- ww_arg_abs_contr_season %>%
  gather_emmeans_draws() %>%
  mutate(copy_numbers = 'absolute')

ggplot(ww_arg_abs_contr_season_draws %>% 
         mutate(.value = exp(.value), season = factor(season, levels = c('fall', 'winter', 'spring'))), 
       aes(x = season,  y = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_summary(fun = median, geom = "point", size = 2) +
  geom_hline(yintercept = 1, linetype = 'dotted', color = 'gray50') +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'effluent/influent ratio') +
  theme(legend.position = c(0.15, 0.8), legend.box = 'horizontal') +
  ggtitle('effluent:influent ARG absolute copy number ratio by season')
```

### Estimated marginal mean and contrast tables

This is the same information as in the plots above, but in table form. As above, medians and four different quantile credible intervals (99%, 95%, 90%, and 66%) are provided.

```{r, echo = FALSE}
ww_arg_gene_type_means %>%
  bind_rows(ww_arg_overall_means) %>%
  mutate(gene = factor(gene, levels = c('OVERALL', as.character(unique(ww_arg_gene_type_means$gene))))) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(gene, type, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(gene, type, estimate, ci99, ci95, ci90, ci66) %>%
  arrange(gene, type) %>%
  gt(caption = glue('Estimated absolute copy numbers in wastewater influent and effluent')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ww_rlt_gene_type_means %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(gene, type, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(gene, type, estimate, ci99, ci95, ci90, ci66) %>%
  arrange(gene, type) %>%
  gt(caption = glue('Estimated relative copy numbers in wastewater influent and effluent')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ww_arg_season_type_means %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(season, type, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(season, type, estimate, ci99, ci95, ci90, ci66) %>%
  arrange(season, type) %>%
  gt(caption = glue('Estimated absolute copy numbers in wastewater influent and effluent by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ww_arg_abs_contr_gene_draws %>%
  bind_rows(ww_arg_abs_contr_overall_draws) %>%
  mutate(gene = factor(gene, levels = c('OVERALL', as.character(unique(ww_arg_gene_type_means$gene))))) %>%
  select(-copy_numbers) %>%
  mutate(.value = exp(.value)) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(gene, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(gene, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Ratio of absolute copy numbers in wastewater effluent/influent by gene')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ww_arg_abs_contr_season_draws %>%
  select(-copy_numbers) %>%
  mutate(.value = exp(.value), season = factor(season, levels = c('fall', 'winter', 'spring'))) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(season, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(season, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Ratio of relative copy numbers in wastewater effluent/influent by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')
```

## Analysis for questions 2k-m. Change in antibiotic concentrations in influent vs. effluent

For the presence-absence question, I will make 2x2 tables in the same way as I did for the presence-absence of the AR taxa.

```{r}
antibiotic_names <- names(ww_antibiotic_conc)[-(1:4)]
ww_antibiotic_conc[, id := rep(1:12, each = 2)]

# Function to make 2x2 table
make_2x2_table <- function(antibiotic) {
  dat_wide <- dcast(ww_antibiotic_conc, id ~ type, value.var = antibiotic)
  dat_wide[, influent := ifelse(influent > 0, 'present', 'absent') |> factor(levels = c('absent', 'present'))]
  dat_wide[, effluent := ifelse(effluent > 0, 'present', 'absent') |> factor(levels = c('absent', 'present'))]
  with(dat_wide, table(influent, effluent))
}

for (antibiotic in antibiotic_names) {
  print(antibiotic)
  print(make_2x2_table(antibiotic))
}
```

We have slightly better numbers for the chi-squared test but I still think not enough to run them. Therefore I will not do any statistical tests for question 2k; instead I will skip directly to questions 2l+2m and look at the concentrations instead. This is very similar to the model for AR gene copy numbers. We will use a hurdle gamma model to account for the non-negative values (concentrations can be exactly zero but cannot be <0). The model will have the same terms as the model for AR copy numbers.

First reshape the data.

```{r}
ww_antconc_long <- melt(ww_antibiotic_conc, id.vars = c('id', 'sample_no', 'season', 'site', 'type'), value.name = 'concentration', variable.name = 'antibiotic')
```

### Fit statistical model

The model includes main effects for influent/effluent, season, and which antibiotic it is, and interactions between influent/effluent x antibiotic, and influent/effluent x antibiotic. There is a random intercept for each ID (combination of season and site). 

```{r}
ww_antconc_fit <- brm(
  concentration ~ type + season + antibiotic + antibiotic:type + season:type + (1|id:site),
   data = ww_antconc_long[!antibiotic %in% 'total'], family = hurdle_gamma(link = 'log', link_shape = 'log', link_hu = 'logit'),
   prior = c(
    prior(normal(0, 3), class = b)
  ),
  chains = 4, iter = 3000, warmup = 2000, seed = 72922,
  file = 'project/ww_antconc_fit'
)
```

As done previously, check convergence and do a posterior predictive check. All looks good.

```{r}
max(rhat(ww_antconc_fit))
pp_check(ww_antconc_fit) + scale_x_log10()
```

### Estimated marginal mean and contrast plots

Calculate and plot estimated marginal means for concentration of each antibiotic in influent and effluent. We will show the overall effect of influent vs. effluent (question 2m), and show the effects separately for each season and for each gene (question 2l). Also, plot contrasts within season and within gene.

The wastewater treatment does not reduce the concentration of antibiotics quite as much. On average it results in a modest reduction but many antibiotics are not reduced very much in concentration, and some even seem to increase (such as Ery). Interestingly, the purifying effect is larger in fall and winter and not effective at all in summer (when the incoming concentration of antibiotics is highest). Again I am not sure if this is an artifact of the small sample sizes or if there is really a pattern there.

```{r, echo = FALSE}
ww_antconc_emm_season <- emmeans(ww_antconc_fit, ~ type | season, type = 'response')
ww_antconc_emm_ant <- emmeans(ww_antconc_fit, ~ type | antibiotic, type = 'response')
ww_antconc_emm_overall <- emmeans(ww_antconc_fit, ~ type, type = 'response')

ww_antconc_contr_ant <- contrast(ww_antconc_emm_ant, 'pairwise')
ww_antconc_contr_season <- contrast(ww_antconc_emm_season, 'pairwise')
ww_antconc_contr_overall <- contrast(ww_antconc_emm_overall, 'pairwise')

pd <- position_dodge(width = 0.3)

# Plots by antibiotic ID
ww_antconc_type_means <- ww_antconc_emm_ant %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value)) %>%
  mutate(type = factor(type, levels = c('influent', 'effluent')))

ww_antconc_overall_means <- ww_antconc_emm_overall %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value)) %>%
  mutate(type = factor(type, levels = c('influent', 'effluent')), antibiotic = 'OVERALL')

pd <- position_dodge(width = 0.5)

ggplot(bind_rows(ww_antconc_type_means, ww_antconc_overall_means) %>%
         mutate(antibiotic = factor(antibiotic, levels = c('OVERALL', as.character(unique(ww_antconc_type_means$antibiotic))))),
       aes(x = antibiotic, group = interaction(antibiotic, type), y = .value)) +
  stat_interval(.width = c(0.66, 0.95), position = pd, size = 2) +
  stat_summary(aes(shape = type), fun = median, geom = "point", size = 2, position = pd) +
  geom_vline(xintercept = 1.5) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'modeled antibiotic concentration') +
  theme(legend.position = 'bottom')

# Plots by season, absolute only
ww_antconc_season_type_means <- ww_antconc_emm_season %>%
  gather_emmeans_draws() %>%
  mutate(.value = exp(.value), 
         season = factor(season, levels = season_order),
         type = factor(type, levels = c('influent', 'effluent'))) 

ggplot(ww_antconc_season_type_means, aes(x = season, group = interaction(season, type), y = .value)) +
  stat_interval(.width = c(0.66, 0.95), position = pd) +
  stat_summary(aes(shape = type), fun = median, geom = "point", size = 2, position = pd) +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'modeled antibiotic concentration') +
  theme(legend.position = c(0.7, 0.15), legend.box = 'horizontal')
```

The contrast plots show that after wastewater treatment, overall antibiotic concentration drops modestly to about 50% of what it was in the influent. This difference is driven by small decreases in all the antibiotics, most of which we don't have certain evidence for them actually decreasing on an individual basis. The season plot shows that the purifying effect is greatest in fall and winter but goes away in summer.

```{r, echo = FALSE}
ww_antconc_contr_ant_draws <- ww_antconc_contr_ant %>%
  gather_emmeans_draws()

ww_antconc_contr_overall_draws <- ww_antconc_contr_overall %>%
  gather_emmeans_draws() %>%
  mutate(antibiotic = 'OVERALL')

ggplot(rbind(ww_antconc_contr_ant_draws, ww_antconc_contr_overall_draws) %>% 
         mutate(.value = exp(.value), 
                antibiotic = factor(antibiotic, levels = c('OVERALL', as.character(unique(ww_antconc_type_means$antibiotic))))), 
       aes(x = antibiotic,  y = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_summary(fun = median, geom = "point", size = 2) +
  geom_vline(xintercept = 1.5) +
  geom_hline(yintercept = 1, linetype = 'dotted', color = 'gray50') +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'effluent/influent ratio') +
  theme(legend.position = c(0.6, 0.15), legend.box = 'horizontal') +
  ggtitle('effluent:influent antibiotic concentration ratio by gene')

ww_antconc_contr_season_draws <- ww_antconc_contr_season %>%
  gather_emmeans_draws()

ggplot(ww_antconc_contr_season_draws %>% 
         mutate(.value = exp(.value), season = factor(season, levels = season_order)), 
       aes(x = season,  y = .value)) +
  stat_interval(.width = c(0.66, 0.95)) +
  stat_summary(fun = median, geom = "point", size = 2) +
  geom_hline(yintercept = 1, linetype = 'dotted', color = 'gray50') +
  scale_color_brewer(palette = 'Blues', name = 'credible interval') +
  scale_y_log10(name = 'effluent/influent ratio') +
  theme(legend.position = c(0.15, 0.8), legend.box = 'horizontal') +
  ggtitle('effluent:influent antibiotic concentration ratio by season')
```

### Estimated marginal mean and contrast tables

This is the same information as in the plots above, but in table form. As always, medians and four different quantile credible intervals (99%, 95%, 90%, and 66%) are provided.

```{r, echo = FALSE}
ww_antconc_type_means %>%
  bind_rows(ww_antconc_overall_means) %>%
  mutate(antibiotic = factor(antibiotic, levels = c('OVERALL', as.character(unique(ww_antconc_type_means$antibiotic))))) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(antibiotic, type, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(antibiotic, type, estimate, ci99, ci95, ci90, ci66) %>%
  arrange(antibiotic, type) %>%
  gt(caption = glue('Estimated antibiotic concentration in wastewater influent and effluent')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ww_antconc_season_type_means %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(season, type, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(season, type, estimate, ci99, ci95, ci90, ci66) %>%
  arrange(season, type) %>%
  gt(caption = glue('Estimated antibiotic concentration in wastewater influent and effluent by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ww_antconc_contr_ant_draws %>%
  bind_rows(ww_antconc_contr_overall_draws) %>%
  mutate(antibiotic = factor(antibiotic, levels = c('OVERALL', as.character(unique(ww_antconc_type_means$antibiotic))))) %>%
  mutate(.value = exp(.value)) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(antibiotic, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(antibiotic, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Ratio of antibiotic concentrations in wastewater effluent/influent')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')

ww_antconc_contr_season_draws %>%
  mutate(.value = exp(.value), season = factor(season, levels = season_order)) %>%
  median_qi(.width = c(0.66, 0.90, 0.95, 0.99)) %>%
  select(-c(.point, .interval)) %>%
  pivot_wider(id_cols = c(season, .value), names_from = .width, values_from = c(.lower, .upper)) %>%
  mutate(estimate = signif(.value, 3), ci99 = print_ci(.lower_0.99, .upper_0.99), ci95 = print_ci(.lower_0.95, .upper_0.95), ci90 = print_ci(.lower_0.9, .upper_0.9), ci66 = print_ci(.lower_0.66, .upper_0.66)) %>%
  select(season, estimate, ci99, ci95, ci90, ci66) %>%
  gt(caption = glue('Ratio of antibiotic concentrations in wastewater effluent/influent by season')) %>%
  cols_label(ci99 = '99% CI', ci95 = '95% CI', ci90 = '90% CI', ci66 = '66% CI') %>%
  tab_options(column_labels.font.weight = 'bold')
```